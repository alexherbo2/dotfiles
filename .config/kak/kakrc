# Kakoune
# https://kakoune.org
# https://github.com/mawww/kakoune
#
# Configuration:
#
# https://github.com/Delapouite/dot-in-the-sky/blob/master/.config/kak/kakrc
# https://github.com/mawww/config/blob/master/kakrc
# https://github.com/occivink/config/blob/master/.config/kak/kakrc
# https://github.com/topisani/dotfiles/blob/master/config/kak/kakrc
# https://gitlab.com/vbauerster/dotfiles/-/blob/master/.config/kak/kakrc

# theme = 'base16_transparent'
# Kakoune keyboard shortcuts
# https://kakoune.org

# VS Code keyboard shortcuts
# https://code.visualstudio.com/docs/getstarted/keybindings#_default-keyboard-shortcuts

# Helix
# https://helix-editor.com
# https://docs.helix-editor.com/keymap.html
# https://docs.helix-editor.com/commands.html
# https://docs.helix-editor.com/configuration.html
# https://github.com/helix-editor/helix/blob/master/helix-term/src/keymap/default.rs
# https://github.com/helix-editor/helix/blob/master/helix-term/src/commands.rs
# https://github.com/helix-editor/helix/blob/master/helix-term/src/commands/typed.rs
# https://github.com/helix-editor/helix/blob/master/helix-view/src/editor.rs

# Preamble ---------------------------------------------------------------------
define-command colorscheme -params 1 -docstring 'load color scheme' %{
  source "%val{config}/colors/%arg{1}.kak"
}
evaluate-commands %sh{
  find -L "$kak_config/autoload" -type f -name '*.kak' -exec printf 'source "%s";' {} +
}
# source "%val{config}/kakrc"
# source ~/.kakrc

# Preamble ---------------------------------------------------------------------

evaluate-commands %sh{
  kak-lsp --kakoune --session "$kak_session"
}
lsp-enable

# Options ----------------------------------------------------------------------

# UI options
set-option global startup_info_version 20221231
set-option global ui_options terminal_set_title=no terminal_assistant=none
# Matching pairs
set-option global matching_pairs ( ) { } [ ] < > “ ” ‘ ’ « » ‹ ›
set-option global scrolloff 5,1
add-highlighter global/show-matching show-matching
add-highlighter global/number-lines number-lines -hlcursor
add-highlighter global/soft_wrap wrap -word -indent -marker '↪'

# Status line
set-option global modelinefmt '%val{bufname} %val{cursor_line}:%val{cursor_char_column} {{context_info}} {{mode_info}} - %val{client}@%val{session}'

# Color scheme: One light (https://git.sr.ht/~raiguard/one.kak)
source "%val{runtime}/colors/default.kak"
# colorscheme one-light

# Custom faces
# set-face global Whitespace "rgb:%opt{bg}+f"
# set-face global SelectedText "rgb:%opt{blue}+f"

# System clipboard
# set-option global clipboard_copy_command 'pbcopy'
# set-option global clipboard_copy_args

# Highlight whitespace
# add-highlighter global/whitespace ref whitespace

# Highlight various characters
# https://unicode-table.com
add-highlighter global/U+2013 regex '–' '0:green+f'
add-highlighter global/U+2014 regex '—' '0:green+bf'
add-highlighter global/math-symbols regex '[−×]' '0:cyan+f'

# Mappings ---------------------------------------------------------------------

map -docstring 'erase characters before cursor to line begin' global insert <c-u> '<a-;>: erase_characters_before_cursor_to_line_begin<ret>'
map -docstring 'paste' global insert <c-y> '<c-r>"'
map -docstring 'Increase indent' global insert <tab> '<a-;><a-gt>'
map -docstring 'Decrease indent' global insert <s-tab> '<a-;><lt>'
map -docstring 'Decrease indent or erase character before cursor' global insert <backspace> '<a-;>: decrease-indent-or-erase-character-before-cursor<ret>'

# Insert various characters.
# Heavily based on qwerty-lafayette.
# https://qwerty-lafayette.org
# See also “Vim digraphs” for defaults.
# https://vimhelp.org/digraph.txt.html#digraphs-default
declare-user-mode digraphs
define-command -hidden insert_text -params 1 %{
  evaluate-commands -save-regs '"' %{
    set-register '"' %arg{1}
    execute-keys -draft ';P'
  }
}
map -docstring 'erase characters before cursor to line begin' global insert <c-u> ''
map -docstring 'enter digraphs mode' global insert <c-k> '<a-;>:enter-user-mode digraphs<ret>'
map -docstring 'â' global digraphs 'q' ':insert_text â<ret>'
map -docstring 'é' global digraphs 'w' ':insert_text é<ret>'
map -docstring 'É' global digraphs 'W' ':insert_text É<ret>'
map -docstring 'è' global digraphs 'e' ':insert_text è<ret>'
map -docstring 'ë' global digraphs 'E' ':insert_text ë<ret>'
map -docstring 'ê' global digraphs 'r' ':insert_text ê<ret>'
map -docstring 'ù' global digraphs 'u' ':insert_text ù<ret>'
map -docstring 'û' global digraphs 'U' ':insert_text û<ret>'
map -docstring 'î' global digraphs 'i' ':insert_text î<ret>'
map -docstring 'ï' global digraphs 'I' ':insert_text ï<ret>'
map -docstring 'ô' global digraphs 'o' ':insert_text ô<ret>'
map -docstring 'ê' global digraphs '[' ':insert_text ê<ret>'
map -docstring 'ë' global digraphs ']' ':insert_text ë<ret>'
map -docstring '«' global digraphs '{' ':insert_text «<ret>'
map -docstring '»' global digraphs '}' ':insert_text »<ret>'
map -docstring 'à' global digraphs 'a' ':insert_text à<ret>'
map -docstring 'À' global digraphs 'A' ':insert_text À<ret>'
map -docstring 'â' global digraphs 's' ':insert_text â<ret>'
map -docstring 'ç' global digraphs 'c' ':insert_text ç<ret>'
map -docstring 'Ç' global digraphs 'C' ':insert_text Ç<ret>'
map -docstring 'æ' global digraphs 'z' ':insert_text æ<ret>'
map -docstring 'œ' global digraphs 'x' ':insert_text œ<ret>'
map -docstring '…' global digraphs '.' ':insert_text …<ret>'
map -docstring '’' global digraphs '<space>' ':insert_text ’<ret>'
map -docstring '“' global digraphs '<lt>' ':insert_text “<ret>'
map -docstring '”' global digraphs '<gt>' ':insert_text ”<ret>'
map -docstring '—' global digraphs '<minus>' ':insert_text —<ret>'
map -docstring '–' global digraphs '_' ':insert_text –<ret>'

# Text objects
# Quotation marks
map -docstring 'double quotation mark' global object <a-Q> 'c“,”<ret>'
map -docstring 'single quotation mark' global object <a-q> 'c‘,’<ret>'
map -docstring 'double angle quotation mark' global object <a-G> 'c«,»<ret>'
map -docstring 'single angle quotation mark' global object <a-g> 'c‹,›<ret>'
# Tag
map -docstring 'tag' global object t 'c<lt>.+?<gt>,<lt>/.+?<gt><ret>'
# Line
map -docstring 'line' global object x '<esc>x_'

# Extended next and previous pairs
map global normal <ret> ':'
map global normal f '<a-:>F'
map global normal F '<a-:><a-;><a-F>'
map global normal t '<a-:>T'
map global normal T '<a-:><a-;><a-T>'
# map global normal / '<a-:>?'
# map global normal ? '<a-:><a-;><a-?>'
# map global normal n '<a-:>?<ret>'
# map global normal N '<a-:><a-;><a-?><ret>'
map global normal x ': select-or-extend-lines<ret>'
map global normal X 'x<a-:><a-;>'
map global normal { '<a-:><a-;>{p'
map global normal } '<a-:>}p'
define-command select-or-extend-lines %{
  execute-keys '<a-:>'
  try %{
    # At least one selection is not full, so select whole lines.
    execute-keys -draft '<a-K>\A^.*\n\z<ret>'
    execute-keys 'x'
  } catch %{
    execute-keys 'Jx'
  }
}

# Normal mode ------------------------------------------------------------------

# Hot reloading
# map -docstring 'reload kakrc' global user <F5> ': source "%val{runtime}/kakrc"; echo reloaded kakrc<ret>'

# Enter command mode
map -docstring 'enter command mode' global normal <ret> :

# Re-center view
# map -docstring 'scroll to put the cursor on the top line of the window' global user , vtvm

# Editing
# map -docstring 'save file' global normal <c-s> ': write; echo -markup ''{Information}file saved''<ret>'
# map -docstring 'close client' global normal <c-q> ': quit<ret>'
# map -docstring 'close buffer' global normal <c-w> ': delete-buffer; echo -markup ''{Information}buffer closed''<ret>'

# Navigation
# map -docstring 'scroll one page up' global normal <pageup> ,<pageup>
# map -docstring 'scroll one page down' global normal <pagedown> ,<pagedown>
# map -docstring 'move to previous paragraph' global normal [ ,gh[pgi
# map -docstring 'move to next paragraph' global normal ] ,]plgi

# Selection primitives
# map -docstring 'enter select mode' global normal s ': enter-select-mode<ret>'

# User mode --------------------------------------------------------------------

# Formatting and parsing date-time
# Format date as “1991-11-02 Sat”.
map -docstring 'format date to 2006-01-02' global user d '| date -d "$kak_selection" ''+%F''<ret>'
map -docstring 'format date to 2006-01-02 Mon' global user D '| date -d "$kak_selection" ''+%F %a''<ret>'
map -docstring 'sanitize text input' global user @ '| iconv -f UTF-8 -t ASCII//TRANSLIT//IGNORE<ret>'

# Show the Unicode value under the cursor.
map -docstring 'Unicode' global user u ': echo -markup "{Information}U+%sh{printf ''%04x'' ""$kak_cursor_char_value""}"<ret>'

# Add search flags
map global prompt <a-i> '<home>(?i)<end>'
map global prompt <a-o> '<home>(?S)<end>'

# Goto mode --------------------------------------------------------------------

# ------------------------------------------------------------------------------

# Commands ---------------------------------------------------------------------

define-command -hidden enter_lsp_mode %{
  enter-user-mode lsp
}

define-command -hidden open_buffer_with_output -params 2.. %{
  set-register f %sh{mktemp -u}
  nop %sh{
    shift
    mkfifo "$kak_reg_f"
    { "$@" > "$kak_reg_f" 2>&1; } < /dev/null > /dev/null 2>&1 &
  }
  edit! -scroll -fifo %reg{f} %arg{1}
  hook -always -once buffer BufCloseFifo '' "
    nop %%sh{
      unlink ""%reg{f}""
    }
  "
}

define-command -hidden select_next_surrounding_object -params 1 %{
  execute-keys "f%arg{1}<a-a>%arg{1}"
}

define-command -hidden select_previous_surrounding_object -params 1 %{
  execute-keys "<a-f>%arg{1}h<a-a>%arg{1}"
}

define-command -hidden swap_buffer_in_viewport -params 1 %{
  execute-keys '"sZ'
  execute-keys -client %arg{1} '"tZ'
  execute-keys '"tz<esc>'
  execute-keys -client %arg{1} '"sz<esc>'
}

# Prompt commands --------------------------------------------------------------

define-command -hidden show_definition_preview_hover %{
  lsp-hover
}

define-command -hidden open_buffer_picker %{
  prompt open: -menu -buffer-completion %{
    buffer %val{text}
  }
}

define-command -hidden open_document_symbol_picker %{
  lsp-goto-document-symbol
}

define-command -hidden open_file_picker %{
  prompt open: -menu -shell-script-candidates 'fd --hidden --type=file' %{
    edit -existing %val{text}
  }
}

define-command -hidden open_global_search_prompt %{
  prompt global_search: -shell-script-candidates %{
    echo "write $kak_quoted_response_fifo" > "$kak_command_fifo"
    tr -sc '[:alnum:]' '\n' < "$kak_response_fifo"
  } %{
    open_buffer_with_output "%val{text}.refs" rg --hidden --column -- %val{text}
  }
}

define-command -hidden open_viewport_picker %{
  prompt -menu viewport_picker: -client-completion %{
    swap_buffer_in_viewport %val{text}
  }
}

define-command -hidden open_workspace_symbol_picker %{
  lsp-workspace-symbol-incr
}

define-command -hidden prompt_select_next_surrounding_object %{
  on-key %{
    select_next_surrounding_object %val{key}
  }
}

define-command -hidden prompt_select_previous_surrounding_object %{
  on-key %{
    select_previous_surrounding_object %val{key}
  }
}

define-command -hidden yank_selected_text_to_terminal_clipboard %{
  nop %sh{
    printf 'echo -to-file %%(%s) -- "%%val{selections}"' "$kak_response_fifo" > "$kak_command_fifo"
    {
      printf '\033]52;c;'
      tr '\0' '\n' < "$kak_response_fifo" | sed 's/\\\\/\\/g' | base64
      printf '\a'
    } > /dev/tty
  }
}

# Mappings ---------------------------------------------------------------------

map -docstring 'enter surround mode' global normal q ':enter_surround_mode<ret>'
map -docstring 'select previous surrounding object' global normal [ ':prompt_select_previous_surrounding_object<ret>'
map -docstring 'select next surrounding object' global normal ] ':prompt_select_next_surrounding_object<ret>'
map -docstring 'open file picker' global user f ':open_file_picker<ret>'
map -docstring 'open buffer picker' global user b ':open_buffer_picker<ret>'
map -docstring 'open global search prompt' global user / ':open_global_search_prompt<ret>'
map -docstring 'open viewport picker' global user v ':open_viewport_picker<ret>'
map -docstring 'open document symbol picker' global user s ':open_document_symbol_picker<ret>'
map -docstring 'open workspace symbol picker' global user S ':open_workspace_symbol_picker<ret>'
map -docstring 'show definition preview hover' global user k ':show_definition_preview_hover<ret>'
map -docstring 'enter lsp mode' global user l ':enter_lsp_mode<ret>'
map -docstring 'yank selected text to the terminal clipboard' global user y ':yank_selected_text_to_terminal_clipboard<ret>'
map -docstring 'find friendly session name' global user R ':find_friendly_session_name<ret>'

# Language support -------------------------------------------------------------

# ------------------------------------------------------------------------------

# Vim-like unimpaired mappings
declare-user-mode unimpaired_left
declare-user-mode unimpaired_right
map -docstring 'unimpaired_left' global user '[' ': enter-user-mode unimpaired_left<ret>'
map -docstring 'unimpaired_right' global user ']' ': enter-user-mode unimpaired_right<ret>'
map -docstring 'read-only' global unimpaired_left r ': set-option buffer readonly yes<ret>'
map -docstring 'read-only' global unimpaired_right r ': set-option buffer readonly no<ret>'
map -docstring 'render whitespace' global unimpaired_left w ': remove-highlighter global/whitespace<ret>'
map -docstring 'render whitespace' global unimpaired_right w ': add-highlighter global/whitespace show-whitespaces<ret>'
map -docstring 'rulers' global unimpaired_left r ': remove-highlighter global/rulers<ret>'
map -docstring 'rulers' global unimpaired_right r ': add-highlighter global/rulers column 81 default,cyan<ret>'

# Commands ---------------------------------------------------------------------

map -docstring 'erase character before cursor' global normal <backspace> ': erase-character-before-cursor<ret>'
map -docstring 'erase character under cursor' global normal <del> ': erase-character-under-cursor<ret>'

map -docstring 'select next word' global normal w ': select-next-word<ret>'

map -docstring 'move line down' global normal <a-down> ': move-lines-down<ret>'
map -docstring 'move line up' global normal <a-up> ': move-lines-up<ret>'

map -docstring 'select all occurrences of current selection' global normal <a-percent> ': select-highlights<ret>'

map -docstring 'increment selection' global normal <c-a> ': increment-selection %val{count}<ret>'
map -docstring 'decrement selection' global normal <c-x> ': decrement-selection %val{count}<ret>'

map -docstring 'buffer directory' global prompt <a-/> '%sh{dirname "$kak_bufname"}<a-!>/'

# Commands ─────────────────────────────────────────────────────────────────────

define-command erase-character-before-cursor -docstring 'erase character before cursor' %{
  execute-keys -draft ';i<backspace>'
}

define-command erase-character-under-cursor -docstring 'erase character under cursor' %{
  execute-keys -draft ';i<del>'
}

define-command select-next-word -docstring 'select next word' %{
  evaluate-commands -itersel %{
    hook -group select-next-word -always -once window User "%val{selection_desc}" %{
      search-next-word
    }
    try %{
      execute-keys '<a-i>w'
      trigger-user-hook "%val{selection_desc}"
    } catch %{
      search-next-word
    }
    remove-hooks window select-next-word
  }
}

define-command -hidden search-next-word -docstring 'search next word' %{
  execute-keys 'h/\W\w<ret><a-i>w'
}

# Reference: https://code.visualstudio.com/docs/getstarted/keybindings#_basic-editing
define-command move-lines-down -docstring 'move line down' %{
  execute-keys -draft 'x<a-_><a-:>Z;ezjxdzP'
}

define-command move-lines-up -docstring 'move line up' %{
  execute-keys -draft 'x<a-_><a-:><a-;>Z;bzkxdzp'
}

define-command select-highlights -docstring 'select all occurrences of current selection' %{
  execute-keys '"aZ*%s<ret>"bZ"az"b<a-z>a'
}

define-command increment-selection -params 1 -docstring 'increment-selection <count>: increment selection by count' %{
  execute-keys "a+%sh{expr $1 '|' 1}<esc>|{ cat; echo; } | bc<ret>"
}

define-command decrement-selection -params 1 -docstring 'decrement-selection <count>: decrement selection by count' %{
  execute-keys "a-%sh{expr $1 '|' 1}<esc>|{ cat; echo; } | bc<ret>"
}

define-command evaluate-selections -docstring 'evaluate selections' %{
  evaluate-commands -itersel %{
    evaluate-commands %val{selection}
  }
}

alias global = evaluate-selections

# Surround selections
# Reference: https://github.com/mawww/kakoune/blob/master/src/normal.cc#:~:text=select_object

define-command -hidden find_friendly_session_name %{
  rename-session %sh{
    curl 'https://myanimelist.net/character.php?limit=[0-1000:50]' |
    kak -f '1shttps://myanimelist.net/character/\d+/(\w+)<ret>y%<a-R>a<ret>' |
    shuf -n 1
  }
}

define-command open_visual_studio_code %{
  nop %sh{
    code --goto "$kak_buffile:$kak_line:$kak_column"
  }
}

define-command alacritty-open-new-client -params .. %{
  nop %sh{
    alacritty msg create-window -e kak -c "$kak_session" -e "$*"
  }
}

complete-command alacritty-open-new-client command

define-command foot-open-new-client -params .. %{
  nop %sh{
    footclient -e kak -c "$kak_session" -e "$*"
  }
}

define-command foot_open_helix -params .. %{
  nop %sh{
    footclient -e hx "$kak_buffile:$kak_line:$kak_column"
  }
}

complete-command foot-open-new-client command

define-command mkdir -docstring 'make directory for the current buffer' %{
  nop %sh(mkdir -p -- "$(dirname -- "$kak_buffile")")
}

# Terminal integration
hook -group alacritty-detection global ClientCreate '.*' %{
  trigger-user-hook "TERM=%val{client_env_TERM}"
}

# Alacritty terminal detection
hook -group alacritty-integration global User 'TERM=alacritty' %{
  alias global open-new-client alacritty-open-new-client
}

# foot terminal detection
hook -group alacritty-integration global User 'TERM=foot' %{
  alias global open-new-client foot-open-new-client
}

define-command open-kakrc -docstring 'open kakrc' %{
  edit "%val{config}/kakrc"
}

define-command open-config -params 1 -docstring 'open from %val{config}' %{
  edit "%val{config}/%arg{1}"
}

complete-command -menu open-config shell-script-candidates %{
  cd "$kak_config" && find -L . -type f | sort -u
}

define-command open-runtime -params 1 -docstring 'open from %val{runtime}' %{
  edit "%val{runtime}/%arg{1}"
}

complete-command -menu open-config shell-script-candidates %{
  cd "$kak_runtime" && find -L . -type f | sort -u
}

# Show Unicode value in the status line.
define-command get_character_info %{
  echo %sh{printf 'U+%04x' "$kak_cursor_char_value"}
}

# Language support -------------------------------------------------------------

# Indentation
set-option global tabstop 4
set-option global indentwidth 2
set-option global disabled_hooks '.+-trim-indent|.+-insert|.+-indent'

# Kakoune
# https://kakoune.org
hook -group config global BufSetOption filetype=kak %{
  set-option buffer indentwidth 2
  set-option buffer line_comment_token '#'
}

# Crystal
# https://crystal-lang.org
hook -group config global BufSetOption filetype=crystal %{
  set-option buffer indentwidth 2
  set-option buffer line_comment_token '#'
}

# JavaScript
# https://developer.mozilla.org/en-US/docs/Web/JavaScript
hook -group config global BufSetOption filetype=javascript %{
  set-option buffer indentwidth 2
  set-option buffer line_comment_token '//'
  set-option buffer block_comment_tokens '/*' '*/'
}

# Lua
# https://lua.org
hook -group config global BufSetOption filetype=lua %{
  set-option buffer indentwidth 2
  set-option buffer line_comment_token '--'
  set-option buffer block_comment_tokens '[[--' '--]]'
}

# Makefile
# https://en.wikipedia.org/wiki/Make_(software)#Makefile
hook -group config global BufSetOption filetype=makefile %{
  set-option buffer indentwidth 0
  set-option buffer line_comment_token '#'
}

# grep
# https://en.wikipedia.org/wiki/Grep
hook -group config global BufSetOption filetype=grep %{
  map buffer normal <ret> ': grep-jump<ret>'
}

# Detection --------------------------------------------------------------------

hook -group config global BufCreate '.*/\.kakrc' %{
  set-option buffer filetype kak
}

hook -group config global BufCreate '.*/(profile|bashrc|tmux.conf)' %{
  set-option buffer filetype sh
}

# Mark

# Iterate selections one by one with `Control+N` and `Control+P`.

# Save selections with `Y` or its strong version `Alt+Y` (same as `Y Space`).

# Clear registers with `D`.  You can specify the register to use.  For example, `"/D` to clear the search register.

# Restore registers as selections with `z` or its strong version `Z` (same as `zD`).

# You can specify the register to use for all commands.

# == Commands

# - `z` ⇒ Restore register.
# - `Z` ⇒ Consume register.

# - `D` ⇒ Clear register.

# - `Y` ⇒ Add selections.
# - `Alt+Y` ⇒ Consume selections.

# - `Control+N` ⇒ Iterate next selection.
# - `Control+P` ⇒ Iterate previous selection.

# == Faces

# - `MarkedPrimaryCursor`
# - `MarkedPrimarySelection`

# - `MarkedSecondaryCursor`
# - `MarkedSecondarySelection`
# Options ──────────────────────────────────────────────────────────────────────

# Internal variables
declare-option -hidden range-specs mark_ranges

# Faces
set-face global MarkedPrimaryCursor '+ub'
set-face global MarkedPrimarySelection '+ub'
set-face global MarkedSecondaryCursor '+u'
set-face global MarkedSecondarySelection '+u'

# Mappings ─────────────────────────────────────────────────────────────────────

map -docstring 'restore register' global normal z ': restore-register %val{register}<ret>'
map -docstring 'consume register' global normal Z ': consume-register %val{register}<ret>'

map -docstring 'clear register' global normal D ': clear-register %val{register}<ret>'

map -docstring 'add selections' global normal Y ': add-selections %val{register}<ret>'
map -docstring 'consume selections' global normal <a-Y> ': consume-selections %val{register}<ret>'

map -docstring 'iterate next selection' global normal <c-n> ': iterate-next-selection %val{register}<ret>'
map -docstring 'iterate previous selection' global normal <c-p> ': iterate-previous-selection %val{register}<ret>'

# Commands ─────────────────────────────────────────────────────────────────────

define-command restore_register -params 1 -docstring 'restore-register <register>: restore register (default: ^)' %{
  try %[ execute-keys """%arg{1}z" ]
}

define-command consume_register -params 1 -docstring 'consume-register <register>: consume register (default: ^)' %{
  restore_register %arg{1}
  clear_register %arg{1}
}

define-command clear_register -params 1 -docstring 'clear-register <register>: clear register (default: ^)' %{
  # Handle null named register.
  try %{
    set-register %arg{1}
    echo -markup "{Information}cleared register '%arg{1}'{Default}"
  } catch %{
    set-register '^'
    echo -markup "{Information}cleared register '^'{Default}"
  }
}

define-command restore_selections -params 1 -docstring 'restore-selections <register>: restore selections (default: ^)' %{
  try %[ execute-keys """%arg{1}<a-z>a" ]
}

define-command save_selections -params 1 -docstring 'save-selections <register>: save selections (default: ^)' %{
  execute-keys -save-regs '' """%arg{1}Z"
}

define-command add_selections -params 1 -docstring 'add-selections <register>: add selections (default: ^)' %{
  evaluate-commands -draft consume-selections %arg{1}
  # Display saved selections:
  # Handle null named register.
  try %{
    execute-keys -save-regs %arg{1} """%arg{1}Z"
  } catch %{
    execute-keys Z
  }
}

define-command consume_selections -params 1 -docstring 'consume-selections <register>: consume selections (default: ^)' %{
  restore_selections %arg{1}
  save_selections %arg{1}
  execute-keys ','
}

define-command iterate_next_selection -params 1 -docstring 'iterate-next-selection <register>: iterate next selection (default: ^)' %{
  restore_register %arg{1}
  execute-keys ')'
  consume_selections %arg{1}
}

define-command iterate_previous_selection -params 1 -docstring 'iterate-previous-selection <register>: iterate previous selection (default: ^)' %{
  restore_register %arg{1}
  execute-keys '('
  consume_selections %arg{1}
}

# Highlighters ─────────────────────────────────────────────────────────────────

define-command -hidden update_mark_ranges %{
  # Reset ranges
  evaluate-commands -buffer '*' unset-option buffer mark_ranges
  try %{
    evaluate-commands -draft %{
      # Jump to the buffer
      execute-keys 'z'
      # Initialize ranges
      set-option buffer mark_ranges %val{timestamp}
      # Mark the main selection
      evaluate-commands -draft %{
        execute-keys ','
        set-option -add buffer mark_ranges "%val{selection_desc}|MarkedPrimarySelection"
        execute-keys ';'
        set-option -add buffer mark_ranges "%val{selection_desc}|MarkedPrimaryCursor"
      }
      # Mark other selections
      execute-keys '<a-,>'
      evaluate-commands -draft -itersel %{
        set-option -add buffer mark_ranges "%val{selection_desc}|MarkedSecondarySelection"
        execute-keys ';'
        set-option -add buffer mark_ranges "%val{selection_desc}|MarkedSecondaryCursor"
      }
    }
  }
}

add-highlighter global/marks ranges mark_ranges
hook -group show-marks -always global RegisterModified '\^' update_mark_ranges
update_mark_ranges

# Notes ------------------------------------------------------------------------

hook -group config global BufCreate '.*/docs/notes.txt' %{
  set-option buffer filetype notes
}

hook -group config global BufSetOption filetype=notes %{
  add-highlighter buffer/notes ref notes
  # Insert date-time as “1991-11-02 Sat 10:52”.
  map -docstring 'insert date (2006-01-02 Mon)' buffer insert <c-u> '<a-;>;<a-;>!date ''+%F %a'' | tr -d ''\n''<ret><right>'
  map -docstring 'insert date (2006-01-02 Mon 15:04)' buffer insert <c-i> '<a-;>;<a-;>!date ''+%F %a %H:%M'' | tr -d ''\n''<ret><right>'
}

add-highlighter shared/notes regions
add-highlighter shared/notes/text default-region group
add-highlighter shared/notes/text/entry-date-year regex '^\d{4}' 0:comment
add-highlighter shared/notes/text/entry-date-year-month regex '^\d{4}-\d{2}' 0:comment
add-highlighter shared/notes/text/entry-date regex '^\d{4}-\d{2}-\d{2} \w{3}' 0:comment
add-highlighter shared/notes/text/entry-date-time regex '^\d{4}-\d{2}-\d{2} \w{3} \d{2}:\d{2}' 0:comment
add-highlighter shared/notes/text/keyword regex '\b(Buy|Go on|Go to|Read|Sign up|Update|Watch)\b' 0:keyword
add-highlighter shared/notes/text/url regex 'https?://\S+' 0:link
add-highlighter shared/notes/info region -recurse '\(' '\(' '\)' group
add-highlighter shared/notes/info/content fill string
add-highlighter shared/notes/info/url ref notes/text/url
add-highlighter shared/notes/info/delimiters regex '(?<opening>.).+(?<closing>.)' opening:string closing:string
add-highlighter shared/notes/tag region -recurse '\[' '\[' '\]' fill meta

# List -------------------------------------------------------------------------

hook -group config global BufCreate '.*/list.txt' %{
  set-option buffer filetype list
}

hook -group config global BufSetOption filetype=list %{
  add-highlighter buffer/list ref list
}

add-highlighter shared/list regions
add-highlighter shared/list/text default-region group
add-highlighter shared/list/text/number regex '\b\d{2}\b' 0:value
add-highlighter shared/list/text/date regex '\b\d{4}-\d{2}-\d{2}\b' 0:string
add-highlighter shared/list/text/year regex '\b\d{4}\b' 0:string
add-highlighter shared/list/text/keyword regex '\b(Movie|Special)\b' 0:keyword
add-highlighter shared/list/text/url regex 'https?://\S+' 0:link

# Pipe selections as JSON Lines to work with traditional Unix tools.
#
# JSON Lines
# https://jsonlines.org
#
# Why Kakoune — A better unix citizen
# https://kakoune.org/why-kakoune/why-kakoune.html#_a_better_unix_citizen

# Mappings ─────────────────────────────────────────────────────────────────────

map -docstring 'pipe (jsonl)' global user | ': pipe-selections-as-jsonl-prompt<ret>'

# Commands ─────────────────────────────────────────────────────────────────────

define-command pipe-selections-as-jsonl-prompt -docstring 'pipe selections as JSON Lines' %{
  prompt 'pipe (jsonl):' -shell-completion %{
    pipe-selections-as-jsonl %val{text}
  }
}

define-command pipe-selections-as-jsonl -params 1.. -docstring 'pipe-selections-as-jsonl <command> [arguments]: pipe selections as JSON Lines' %{
  evaluate-commands -save-regs '"' %sh{
    # Path to selections as JSON Lines
    selections_path=$(mktemp)

    # Cleanup temporary files
    trap at_exit EXIT
    at_exit() {
      rm -f "$selections_path"
    }

    # Terminates execution immediately, printing message to Kakoune.
    abort() {
      echo "fail $1"
      exit 1
    }

    # Serialize (Shell → JSON Lines) and run the shell command.
    shell_command=$@
    eval set -- "$kak_quoted_selections"
    jq --null-input '$ARGS.positional[]' --args -- "$@" |
    sh -c "$shell_command" > "$selections_path"

    # Abort with non-zero exit status
    [ $? = 0 ] || abort "pipe exit status: $?"

    # Validate the command output
    jq --exit-status --slurp 'all(type == "string")' "$selections_path" > /dev/null || abort "selections are not JSON Lines"

    # Serialize (JSON Lines → Kakoune) and set the selections.
    export squote="'"
    jq --slurp --raw-output '["set-register", "dquote"] + map(env.squote + gsub(env.squote; env.squote + env.squote) + env.squote) | join(" ")' "$selections_path"
    echo execute-keys R
  }
}

hook -group c-configuration global BufSetOption filetype=c %{
  set-option buffer line_comment_token '//'
  set-option buffer block_comment_tokens '/*' '*/'
  set-option buffer indentation_rules_increase_indent_pattern ''
  set-option buffer indentation_rules_decrease_indent_pattern ''
}

# Git
# Mappings
map -docstring 'Toggle comments' global normal '#' ': toggle-comments<ret>'
# == Faces
# Whitespace characters:
# - `Tab` ⇒ `WhitespaceError`
# - `Newline` ⇒ `Whitespace`
# - `NonBreakingSpace` ⇒ `WhitespaceError`
# - `Indent` ⇒ `Whitespace`
# - `MixedIndent` ⇒ `WhitespaceError`
# - `OddIndent` ⇒ `WhitespaceError`
# Extra whitespace:
# - `TrailingWhitespace` ⇒ `WhitespaceError`
# - `ConsecutiveWhitespace` ⇒ `WhitespaceWarning`
# Generic faces:
# - `WhitespaceRuler` ⇒ `green+fu`
# - `WhitespaceError` ⇒ `red+fc`
# - `WhitespaceWarning` ⇒ `red+fc`
# add-highlighter global/whitespace ref whitespace
# * Individual faces for whitespace (tabs, newlines, non-breaking-spaces) and indent.
# * Show whitespace oddities:
# ** Trailing whitespace (only shown when not in insert mode).
# ** Odd and mixed indent.
# * Show consecutive whitespace.
# * Show limit of 80 characters (useful for horizontal lines).
# add-highlighter global/whitespace ref whitespace
# Refined show whitespace

# Faces ────────────────────────────────────────────────────────────────────────

# Whitespace characters:
set-face global Tab WhitespaceError
set-face global Newline Whitespace
set-face global NonBreakingSpace WhitespaceError

# Indentation rules:
set-face global Indent Whitespace
set-face global MixedIndent WhitespaceError
set-face global OddIndent WhitespaceError

# Extra whitespace:
set-face global TrailingWhitespace WhitespaceError
set-face global ConsecutiveWhitespace WhitespaceWarning

# Generic faces:
set-face global WhitespaceRuler 'green+fu'
set-face global WhitespaceError 'red+fc'
set-face global WhitespaceWarning 'red+fc'

# Hooks ────────────────────────────────────────────────────────────────────────

# Only shown when not in insert mode.
remove-hooks global whitespace
hook -group whitespace -always global ModeChange 'push:normal:insert' %{
  set-face window TrailingWhitespace Whitespace
  set-face window ConsecutiveWhitespace Whitespace

  # Restore
  hook -always -once window ModeChange 'pop:insert:normal' %{
    unset-face window TrailingWhitespace
    unset-face window ConsecutiveWhitespace
  }
}

# Highlighters ─────────────────────────────────────────────────────────────────

# Order matters:
#
# “You can think of highlighters as like a list of painting instructions.” — Screwtape
#
add-highlighter shared/whitespace group

# Show whitespace (tabs, newlines, non-breaking-spaces).
add-highlighter shared/whitespace/tab regex '\t+' '0:Tab'
add-highlighter shared/whitespace/newline regex '\n+' '0:Newline'
add-highlighter shared/whitespace/non-breaking-space regex ' +' '0:NonBreakingSpace'

# Show consecutive whitespace, then paint over indent.
add-highlighter shared/whitespace/consecutive-whitespace regex '\h{2,}' '0:ConsecutiveWhitespace'
add-highlighter shared/whitespace/indent regex '^\h+' '0:Indent'

# Show trailing whitespace.
add-highlighter shared/whitespace/trailing-whitespace regex '\h+$' '0:TrailingWhitespace'

# Show odd and mixed indent.
add-highlighter shared/whitespace/odd-indent regex '^( {1}| {3}| {5}| {7}| {9}| {11}| {13}| {15}| {17}| {19})(?=\H)' '0:OddIndent'
add-highlighter shared/whitespace/mixed-indent regex '^(\t+ | +\t)\h*' '0:MixedIndent'

# Show limit of 80 characters.
add-highlighter shared/whitespace/ruler regex '(?S)^.{80}$\K\n' '0:WhitespaceRuler'

# Sensible
# Enter `search` and start typing to search.
# Press `Tab` to skim through the occurrences.
# Show search with `show-search` or enter search mode then `Escape`.

# Options ──────────────────────────────────────────────────────────────────────

# Sensible scroll-off: 5 lines and 1 column.
# Initialization
# Highlighters

# set-face global LineNumberSelected red
# offscreen
# hidden
# MultipleSelections
# set-face global insert green
# set-face global selection blue

# Commands ─────────────────────────────────────────────────────────────────────

# Faces
set-face global Search 'black,yellow'
add-highlighter shared/search dynregex '%reg{/}' 0:Search

hook -group show-search -always global NormalKey '/|<a-/>|\?|<a-\?>' %{
  add-highlighter window/search ref search
  hook -always -once window ModeChange 'pop:prompt:normal' %{
    remove-highlighter window/search
    # remove-highlighter window/wrap
  }
}

hook -group show-search global RegisterModified '/' %{
  try %{
    add-highlighter shared/search regex "%reg{/}" 0:Search
  } catch %{
    remove-highlighter shared/search
  }
}

# Internal variables
declare-option -hidden range-specs selected_text_ranges

set-face global Search black,yellow+fg
set-face global SelectedText black,blue+fg

define-command -hidden update-selected-text-ranges %{
  # Reset ranges
  unset-option window selected_text_ranges
  try %{
    evaluate-commands -draft -save-regs '^' %{
      execute-keys '<a-k>..<ret>'
      execute-keys '<a-K>\A\h+\z<ret>'
      # Initialize ranges
      set-option window selected_text_ranges %val{timestamp}
      # Mark the main selection
      # Mark other selections
      evaluate-commands -draft %{
        execute-keys '*%s<ret>'
        evaluate-commands -itersel %{
          set-option -add window selected_text_ranges "%val{selection_desc}|SelectedText"
        }
      }
      evaluate-commands -itersel %{
        set-option -remove window selected_text_ranges "%val{selection_desc}|SelectedText"
      }
    }
  }
}

# Initialization
add-highlighter global/selected-text ranges selected_text_ranges
remove-hooks global show-selected-text
hook -group show-selected-text -always global NormalIdle '' update-selected-text-ranges
hook -group show-selected-text -always global InsertIdle '' update-selected-text-ranges

hook global BufCreate .*\.(diff|patch) %{
    set-option buffer filetype diff
}

hook global WinSetOption filetype=diff %{
    require-module diff
    map buffer normal <ret> :diff-jump<ret>
}

hook -group diff-highlight global WinSetOption filetype=diff %{
    add-highlighter window/diff ref diff
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/diff }
}

provide-module diff %§

add-highlighter shared/diff group
add-highlighter shared/diff/ regex "^\+[^\n]*\n" 0:green,default
add-highlighter shared/diff/ regex "^-[^\n]*\n" 0:red,default
add-highlighter shared/diff/ regex "^@@[^\n]*@@" 0:cyan,default
# If any trailing whitespace was introduced in diff, show it with red background
add-highlighter shared/diff/ regex "^\+[^\n]*?(\h+)\n" 1:default,red

define-command diff-jump -params .. -docstring %{
        diff-jump [<switches>] [<directory>]: edit the diff's source file at the cursor position.
        Paths are resolved relative to <directory>, or the current working directory if unspecified.

        Switches:
            -       jump to the old file instead of the new file
            -<num> strip <num> leading directory components, like -p<num> in patch(1). Defaults to 1 if there is a 'diff' line (as printed by 'diff -r'), or 0 otherwise.
    } %{
    evaluate-commands -draft -save-regs ac| %{
        # Save the column because we will move the cursor.
        set-register c %val{cursor_column}
        # If there is a "diff" line, we don't need to look further back.
        try %{
            execute-keys %{<a-l><semicolon><a-?>^(?:> )*diff\b<ret>x}
        } catch %{
            # A single file diff won't have a diff line. Start parsing from
            # the buffer start, so we can tell if +++/--- lines are headers
            # or content.
            execute-keys Gk
        }
        set-register a %arg{@}
        set-register | %{
            [ -n "$kak_reg_a" ] && eval set -- $kak_quoted_reg_a
            cmd=$(column=$kak_reg_c perl -we '
                sub quote {
                    $SQ = "'\''";
                    $token = shift;
                    $token =~ s/$SQ/$SQ$SQ/g;
                    return "$SQ$token$SQ";
                }
                sub fail {
                    $reason = shift;
                    print "fail " . quote("diff-jump: $reason");
                    exit;
                }
                $version = "+", $other_version = "-";
                $strip = undef;
                $directory = $ENV{PWD};
                $seen_ddash = 0;
                foreach (@ARGV) {
                    if ($seen_ddash or !m{^-}) {
                        $directory = $_;
                    } elsif ($_ eq "-") {
                        $version = "-", $other_version = "+";
                    } elsif (m{^-(\d+)$}) {
                        $strip = $1;
                    } elsif ($_ eq "--") {
                        $seen_ddash = 1;
                    } else {
                        fail "unknown option: $_";
                    }
                }
                $have_diff_line = 0;
                $state = "header";
                while (<STDIN>) {
                    s/^(> )*//g;
                    $last_line = $_;
                    if (m{^diff\b}) {
                        $state = "header";
                        $have_diff_line = 1;
                        if (m{^diff -\S* (\S+) (\S+)$}) {
                            $fallback_file = $version eq "+" ? $2 : $1;
                        }
                        next;
                    }
                    if ($state eq "header") {
                        if (m{^[$version]{3} ([^\t\n]+)}) {
                            $file = $1;
                            next;
                        }
                        if (m{^[$other_version]{3} ([^\t\n]+)}) {
                            $fallback_file = $1;
                            next;
                        }
                    }
                    if (m{^@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@}) {
                        $state = "contents";
                        $line = ($version eq "+" ? $2 : $1) - 1;
                    } elsif (m{^[ $version]}) {
                        $line++ if defined $line;
                    }
                }
                if (not defined $file) {
                    $file = $fallback_file;
                }
                if (not defined $file) {
                    fail "missing diff header";
                }
                if (not defined $strip) {
                    # A "diff -r" or "git diff" adds "diff" lines to
                    # the output.  If no such line is present, we have
                    # a plain diff between files (not directories), so
                    # there should be no need to strip the directory.
                    $strip = $have_diff_line ? 1 : 0;
                }
                if ($file !~ m{^/}) {
                    $file =~ s,^([^/]+/+){$strip},, or fail "directory prefix underflow";
                    $file = "$directory/$file";
                }

                if (defined $line) {
                    $column = $ENV{column} - 1; # Account for [ +-] diff prefix.
                    # If the cursor was on a hunk header, go to the section header if possible.
                    if ($last_line =~ m{^(@@ -\d+(?:,\d+)? \+\d+(?:,\d+) @@ )([^\n]*)}) {
                        $hunk_header_prefix = $1;
                        $hunk_header_from_userdiff = $2;
                        open FILE, "<", $file or fail "failed to open file: $!: $file";
                        @lines = <FILE>;
                        for (my $i = $line - 1; $i >= 0 && $i < scalar @lines; $i--) {
                            if ($lines[$i] !~ m{\Q$hunk_header_from_userdiff}) {
                                next;
                            }
                            $line = $i + 1;
                            # Re-add 1 because the @@ line does not have a [ +-] diff prefix.
                            $column = $column + 1 - length $hunk_header_prefix;
                            last;
                        }
                    }
                }

                printf "edit -existing -- %s $line $column", quote($file);
            ' -- "$@")
            echo "set-register c $cmd" >"$kak_command_fifo"
        }
        execute-keys <a-|><ret>
        evaluate-commands -client %val{client} %{
            evaluate-commands -try-client %opt{jumpclient} %{
                %reg{c}
            }
        }
    }
}
complete-command diff-jump file

§

define-command \
    -docstring %{diff-select-file: Select surrounding patch file} \
    -params 0 \
    diff-select-file %{
                evaluate-commands -itersel -save-regs 'ose/' %{
        try %{
            execute-keys '"oZgl<a-?>^diff <ret>;"sZ' 'Ge"eZ'
            try %{ execute-keys '"sz?\n(?=diff )<ret>"e<a-Z><lt>' }
            execute-keys '"ez'
        } catch %{
            execute-keys '"oz'
            fail 'Not in a diff file'
        }
    }
}

define-command \
    -docstring %{diff-select-hunk: Select surrounding patch hunk} \
    -params 0 \
    diff-select-hunk %{
    evaluate-commands -itersel -save-regs 'ose/' %{
        try %{
            execute-keys '"oZgl<a-?>^@@ <ret>;"sZ' 'Ge"eZ'
            try %{ execute-keys '"sz?\n(?=diff )<ret>"e<a-Z><lt>' }
            try %{ execute-keys '"sz?\n(?=@@ )<ret>"e<a-Z><lt>' }
            execute-keys '"ez'
        } catch %{
            execute-keys '"oz'
            fail 'Not in a diff hunk'
        }
    }
}
declare-option -docstring "name of the client in which documentation is to be displayed" \
    str docsclient

declare-option -hidden range-specs doc_render_ranges
declare-option -hidden range-specs doc_links
declare-option -hidden range-specs doc_anchors

define-command -hidden -params 4 doc-render-regex %{
    evaluate-commands -draft %{ try %{
        execute-keys <percent> s %arg{1} <ret>
        execute-keys -draft s %arg{2} <ret> d
        execute-keys "%arg{3}"
        evaluate-commands %sh{
            face="$4"
            eval "set -- $kak_quoted_selections_desc"
            ranges=""
            for desc in "$@"; do ranges="$ranges '$desc|$face'"; done
            echo "update-option buffer doc_render_ranges"
            echo "set-option -add buffer doc_render_ranges $ranges"
        }
    } }
}

define-command -hidden doc-parse-links %{
    evaluate-commands -draft %{ try %{
        execute-keys <percent> s <lt><lt>(.*?),.*?<gt><gt> <ret>
        execute-keys -draft s <lt><lt>.*,|<gt><gt> <ret> d
        execute-keys H
        set-option buffer doc_links %val{timestamp}
        update-option buffer doc_render_ranges
        evaluate-commands -itersel %{
            set-option -add buffer doc_links "%val{selection_desc}|%reg{1}"
            set-option -add buffer doc_render_ranges "%val{selection_desc}|default+u"
        }
    } }
}

define-command -hidden doc-parse-anchors %{
    evaluate-commands -draft %{ try %{
        set-option buffer doc_anchors %val{timestamp}
        # Find sections as add them as imlicit anchors
        execute-keys <percent> s ^={2,}\h+([^\n]+)$ <ret>
        evaluate-commands -itersel %{
            set-option -add buffer doc_anchors "%val{selection_desc}|%sh{printf '%s' ""$kak_main_reg_1"" | tr '[A-Z ]' '[a-z-]'}"
        }

        # Parse explicit anchors and remove their text
        execute-keys <percent> s \[\[(.*?)\]\]\s* <ret>
        evaluate-commands -itersel %{
            set-option -add buffer doc_anchors "%val{selection_desc}|%reg{1}"
        }
        execute-keys d
        update-option buffer doc_anchors
    } }
}

define-command -hidden doc-jump-to-anchor -params 1 %{
    update-option buffer doc_anchors
    evaluate-commands %sh{
        anchor="$1"
        eval "set -- $kak_quoted_opt_doc_anchors"

        shift
        for range in "$@"; do
            if [ "${range#*|}" = "$anchor" ]; then
                printf '%s\n'  "select '${range%|*}'; execute-keys vv"
                exit
            fi
        done
        printf "fail No such anchor '%s'\n" "${anchor}"
    }
}

define-command -hidden doc-follow-link %{
    update-option buffer doc_links
    evaluate-commands %sh{
        eval "set -- $kak_quoted_opt_doc_links"
        for link in "$@"; do
            printf '%s\n' "$link"
        done | awk -v FS='[.,|#]' '
            BEGIN {
                l=ENVIRON["kak_cursor_line"];
                c=ENVIRON["kak_cursor_column"];
            }
            l >= $1 && c >= $2 && l <= $3 && c <= $4 {
                if (NF == 6) {
                    print "doc " $5
                    if ($6 != "") {
                        print "doc-jump-to-anchor %{" $6 "}"
                    }
                } else {
                    print "doc-jump-to-anchor %{" $5 "}"
                }
                exit
            }
        '
    }
}

define-command -params 1 -hidden doc-render %{
    edit! -scratch "*doc-%sh{basename $1 .asciidoc}*"
    execute-keys "!cat %arg{1}<ret>gg"

    doc-parse-anchors

    # Join paragraphs together
    try %{
        execute-keys -draft '%S\n{2,}|(?<lt>=\+)\n|^[^\n]+::\n|^\h*[*-]\h+<ret>' \
            <a-K>^\h*-{2,}(\n|\z)<ret> S\n\z<ret> <a-k>\n<ret> <a-j>
    }

    # Remove some line end markers
    try %{ execute-keys -draft <percent> s \h*(\+|:{2,})$ <ret> d }

    # Setup the doc_render_ranges option
    set-option buffer doc_render_ranges %val{timestamp}
    doc-render-regex \B(?<!\\)\*(?=\S)[^\n]+?(?<=\S)(?<!\\)\*\B \A|.\z 'H' default+b
    doc-render-regex \b(?<!\\)_(?=\S)[^\n]+?(?<=\S)(?<!\\)_\b \A|.\z 'H' default+i
    doc-render-regex \B(?<!\\)`(?=\S)[^\n]+?(?<=\S)`\B \A|.\z 'H' mono
    doc-render-regex ^=\h+[^\n]+ ^=\h+ '~' title
    doc-render-regex ^={2,}\h+[^\n]+ ^={2,}\h+ '' header
    doc-render-regex ^\h*-{2,}\n\h*.*?^\h*-{2,}\n ^\h*-{2,}\n '' block

    doc-parse-links

    # Remove escaping of * and `
    try %{ execute-keys -draft <percent> s \\((?=\*)|(?=`)) <ret> d }
    # Go to beginning of file
    execute-keys 'gg'

    set-option buffer readonly true
    add-highlighter buffer/ ranges doc_render_ranges
    add-highlighter buffer/ wrap -word -indent
    map buffer normal <ret> :doc-follow-link<ret>
}

define-command doc -params 0..2 -menu -docstring %{
        doc <topic> [<keyword>]: open a buffer containing documentation about a given topic
        An optional keyword argument can be passed to the function, which will be automatically selected in the documentation

        See `:doc doc` for details.
    } %{
    evaluate-commands %sh{
        topic="doc"
        if [ $# -ge 1 ]; then
            topic="$1"
        fi
        page=$(
            find -L \
                "${kak_config}/autoload/" \
                "${kak_runtime}/doc/" \
                "${kak_runtime}/rc/" \
                -type f -name "$topic.asciidoc" 2>/dev/null |
                head -1
        )
        if [ -f "${page}" ]; then
            jump_cmd=""
            if [ $# -eq 2 ]; then
                jump_cmd="doc-jump-to-anchor '$2'"
            fi
            printf %s\\n "evaluate-commands -try-client %opt{docsclient} %{ doc-render ${page}; ${jump_cmd} }"
        else
            printf 'fail No such doc file: %s\n' "$topic.asciidoc"
        fi
    }
}

complete-command doc shell-script-candidates %{
    case "$kak_token_to_complete" in
        0)
            find -L \
                "${kak_config}/autoload/" \
                "${kak_runtime}/doc/" \
                "${kak_runtime}/rc/" \
                -type f -name "*.asciidoc" 2>/dev/null |
                sed 's,.*/,,; s/\.[^.]*$//';;
        1)
            page=$(
                find -L \
                    "${kak_config}/autoload/" \
                    "${kak_runtime}/doc/" \
                    "${kak_runtime}/rc/" \
                    -type f -name "$1.asciidoc" 2>/dev/null |
                    head -1
            )
            if [ -f "${page}" ]; then
                awk '
                    /^==+ +/ { sub(/^==+ +/, ""); print }
                    /^\[\[[^\]]+\]\]/ { sub(/^\[\[/, ""); sub(/\]\].*/, ""); print }
                ' < $page | tr '[A-Z ]' '[a-z-]'
            fi;;
    esac
}

alias global help doc
hook global BufCreate .*(COMMIT_EDITMSG|MERGE_MSG) %{
    set-option buffer filetype git-commit
}

hook global BufCreate .*/NOTES_EDITMSG %{
    set-option buffer filetype git-notes
}

hook global BufCreate .*(\.git(config|modules)|git/config) %{
    set-option buffer filetype ini
}

hook global BufCreate .*\.gitignore %{
    set-option buffer filetype git-ignore
}

hook global BufCreate .*git-rebase-todo %{
    set-option buffer filetype git-rebase
}

hook global WinSetOption filetype=git-(commit|ignore|notes|rebase) %{
    require-module "git-%val{hook_param_capture_1}"
}

hook -group git-commit-highlight global WinSetOption filetype=git-commit %{
    add-highlighter window/git-commit ref git-commit
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/git-commit }
}

hook -group git-ignore-highlight global WinSetOption filetype=git-ignore %{
    add-highlighter window/git-ignore ref git-ignore
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/git-ignore }
}

hook -group git-notes-highlight global WinSetOption filetype=git-notes %{
    add-highlighter window/git-notes ref git-notes
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/git-notes }
}

hook -group git-rebase-highlight global WinSetOption filetype=git-rebase %{
    add-highlighter window/git-rebase ref git-rebase
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/git-rebase }
}

provide-module git-commit %{
require-module diff
add-highlighter shared/git-commit regions
add-highlighter shared/git-commit/diff region '^diff --git' '^(?=diff --git)' ref diff # highlight potential diffs from the -v option
add-highlighter shared/git-commit/comments region ^# $ group
add-highlighter shared/git-commit/comments/ fill comment
add-highlighter shared/git-commit/comments/ regex "\b(?:(modified)|(deleted)|(new file)|(renamed|copied)):([^\n]*)$" 1:yellow 2:red 3:green 4:blue 5:magenta
}

provide-module git-ignore %{
add-highlighter shared/git-ignore group
add-highlighter shared/git-ignore/glob regex '(?<!\\)(?:\\\\)*\K(\*\*?|\?|\[.*?(?<!\\)(?:\\\\)*\])' 0:operator
add-highlighter shared/git-ignore/negate regex '^!' 0:operator
add-highlighter shared/git-ignore/comments regex '^#.*?$' 0:comment
}

provide-module git-notes %{
add-highlighter shared/git-notes regex ^#[^\n]*$ 0:comment
}

provide-module git-rebase %{
add-highlighter shared/git-rebase group
add-highlighter shared/git-rebase/ regex "^\h*#[^\n]*\n" 0:comment
add-highlighter shared/git-rebase/ regex "^(?:(pick|p)|(edit|reword|squash|fixup|exec|break|drop|label|reset|merge|[ersfxbdltm])) (\w+)" 1:keyword 2:value 3:meta
}

# http://json.org
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

# Detection
# ‾‾‾‾‾‾‾‾‾

hook global BufCreate .*[.](json) %{
    set-option buffer filetype json
}

# Initialization
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾

hook global WinSetOption filetype=json %{
    require-module json

    hook window ModeChange pop:insert:.* -group json-trim-indent json-trim-indent
    hook window InsertChar .* -group json-indent json-indent-on-char
    hook window InsertChar \n -group json-indent json-indent-on-new-line

    hook -once -always window WinSetOption filetype=.* %{ remove-hooks window json-.+ }
}

hook -group json-highlight global WinSetOption filetype=json %{
    add-highlighter window/json ref json
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/json }
}


provide-module json %(

# Highlighters
# ‾‾‾‾‾‾‾‾‾‾‾‾

add-highlighter shared/json regions
add-highlighter shared/json/code default-region group
add-highlighter shared/json/string region '"' (?<!\\)(\\\\)*" fill string

add-highlighter shared/json/code/ regex \b(true|false|null|\d+(?:\.\d+)?(?:[eE][+-]?\d*)?)\b 0:value

# Commands
# ‾‾‾‾‾‾‾‾

define-command -hidden json-trim-indent %{
    # remove trailing white spaces
    try %{ execute-keys -draft -itersel x s \h+$ <ret> d }
}

define-command -hidden json-indent-on-char %<
    evaluate-commands -draft -itersel %<
        # align closer token to its opener when alone on a line
        try %< execute-keys -draft <a-h> <a-k> ^\h+[\]}]$ <ret> m <a-S> 1<a-&> >
    >
>

define-command -hidden json-indent-on-new-line %<
    evaluate-commands -draft -itersel %<
        # preserve previous line indent
        try %{ execute-keys -draft <semicolon> K <a-&> }
        # filter previous line
        try %{ execute-keys -draft k : json-trim-indent <ret> }
        # indent after lines ending with opener token
        try %< execute-keys -draft k x <a-k> [[{]\h*$ <ret> j <a-gt> >
        # deindent closer token(s) when after cursor
        try %< execute-keys -draft x <a-k> ^\h*[}\]] <ret> gh / [}\]] <ret> m <a-S> 1<a-&> >
    >
>

)
declare-option -docstring "shell command run to build the project" \
    str makecmd make
declare-option -docstring "pattern that describes lines containing information about errors in the output of the `makecmd` command" \
    str make_error_pattern " (?:fatal )?error:"

declare-option -docstring "name of the client in which utilities display information" \
    str toolsclient
declare-option -hidden int make_current_error_line

define-command -params .. \
    -docstring %{
        make [<arguments>]: make utility wrapper
        All the optional arguments are forwarded to the make utility
     } make %{ evaluate-commands %sh{
     output=$(mktemp -d "${TMPDIR:-/tmp}"/kak-make.XXXXXXXX)/fifo
     mkfifo ${output}
     ( eval "${kak_opt_makecmd}" "$@" > ${output} 2>&1 & ) > /dev/null 2>&1 < /dev/null

     printf %s\\n "evaluate-commands -try-client '$kak_opt_toolsclient' %{
               edit! -fifo ${output} -scroll *make*
               set-option buffer filetype make
               set-option buffer make_current_error_line 0
               hook -always -once buffer BufCloseFifo .* %{ nop %sh{ rm -r $(dirname ${output}) } }
           }"
}}

add-highlighter shared/make group
add-highlighter shared/make/ regex "^((?:\w:)?[^:\n]+):(\d+):(?:(\d+):)?\h+(?:((?:fatal )?error)|(warning)|(note)|(required from(?: here)?))?.*?$" 1:cyan 2:green 3:green 4:red 5:yellow 6:blue 7:yellow
add-highlighter shared/make/ regex "^\h*(~*(?:(\^)~*)?)$" 1:green 2:cyan+b
add-highlighter shared/make/ line '%opt{make_current_error_line}' default+b

hook -group make-highlight global WinSetOption filetype=make %{
    add-highlighter window/make ref make
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/make }
}

hook global WinSetOption filetype=make %{
    hook buffer -group make-hooks NormalKey <ret> make-jump
    hook -once -always window WinSetOption filetype=.* %{ remove-hooks buffer make-hooks }
}

declare-option -docstring "name of the client in which all source code jumps will be executed" \
    str jumpclient

define-command -hidden make-open-error -params 4 %{
    evaluate-commands -try-client %opt{jumpclient} %{
        edit -existing "%arg{1}" %arg{2} %arg{3}
        echo -markup "{Information}{\}%arg{4}"
        try %{ focus }
    }
}

define-command -hidden make-jump %{
    evaluate-commands %{
        try %{
            execute-keys gl<a-?> "Entering directory" <ret><a-:>
            # Try to parse the error into capture groups, failing on absolute paths
            execute-keys s "Entering directory [`']([^']+)'.*\n([^:/][^:]*):(\d+):(?:(\d+):)?([^\n]+)\z" <ret>l
            set-option buffer make_current_error_line %val{cursor_line}
            make-open-error "%reg{1}/%reg{2}" "%reg{3}" "%reg{4}" "%reg{5}"
        } catch %{
            execute-keys <a-h><a-l> s "((?:\w:)?[^:]+):(\d+):(?:(\d+):)?([^\n]+)\z" <ret>l
            set-option buffer make_current_error_line %val{cursor_line}
            make-open-error "%reg{1}" "%reg{2}" "%reg{3}" "%reg{4}"
        }
    }
}

define-command make-next-error -docstring 'Jump to the next make error' %{
    evaluate-commands -try-client %opt{jumpclient} %{
        buffer '*make*'
        execute-keys "%opt{make_current_error_line}ggl" "/^(?:\w:)?[^:\n]+:\d+:(?:\d+:)?%opt{make_error_pattern}<ret>"
        make-jump
    }
    try %{
        evaluate-commands -client %opt{toolsclient} %{
            buffer '*make*'
            execute-keys %opt{make_current_error_line}g
        }
    }
}

define-command make-previous-error -docstring 'Jump to the previous make error' %{
    evaluate-commands -try-client %opt{jumpclient} %{
        buffer '*make*'
        execute-keys "%opt{make_current_error_line}g" "<a-/>^(?:\w:)?[^:\n]+:\d+:(?:\d+:)?%opt{make_error_pattern}<ret>"
        make-jump
    }
    try %{
        evaluate-commands -client %opt{toolsclient} %{
            buffer '*make*'
            execute-keys %opt{make_current_error_line}g
        }
    }
}
declare-option -docstring "name of the client in which documentation is to be displayed" \
    str docsclient

declare-option -hidden str-list manpage

hook -group man-highlight global WinSetOption filetype=man %{
    add-highlighter window/man-highlight group
    # Sections
    add-highlighter window/man-highlight/ regex ^\S.*?$ 0:title
    # Subsections
    add-highlighter window/man-highlight/ regex '^ {3}\S.*?$' 0:default+b
    # Command line options
    add-highlighter window/man-highlight/ regex '^ {7}-[^\s,]+(,\s+-[^\s,]+)*' 0:list
    # References to other manpages
    add-highlighter window/man-highlight/ regex [-a-zA-Z0-9_.]+\([a-z0-9]+\) 0:header

    map window normal <ret> :man-jump<ret>

    hook -once -always window WinSetOption filetype=.* %{
      remove-highlighter window/man-highlight
      unmap window normal <ret>
    }
}

hook global WinSetOption filetype=man %{
    hook -group man-hooks window WinResize .* %{ man-impl %opt{manpage} }
    hook -once -always window WinSetOption filetype=.* %{ remove-hooks window man-hooks }
}

define-command -hidden -params ..3 man-impl %{ evaluate-commands %sh{
    buffer_name="$1"
    if [ -z "${buffer_name}" ]; then
        exit
    fi
    shift
    manout=$(mktemp "${TMPDIR:-/tmp}"/kak-man.XXXXXX)
    manerr=$(mktemp "${TMPDIR:-/tmp}"/kak-man.XXXXXX)
    colout=$(mktemp "${TMPDIR:-/tmp}"/kak-man.XXXXXX)
    env MANWIDTH=${kak_window_range##* } man "$@" > "$manout" 2> "$manerr"
    retval=$?
    if command -v col >/dev/null; then
        col -b -x > ${colout} < ${manout}
    else
        sed 's/.//g' > ${colout} < ${manout}
    fi
    rm ${manout}

    if [ "${retval}" -eq 0 ]; then
        printf %s\\n "
                edit -scratch %{*$buffer_name ${*}*}
                execute-keys '%|cat<space>${colout}<ret>gk'
                nop %sh{ rm ${colout}; rm ${manerr} }
                set-option buffer filetype man
                set-option window manpage $buffer_name $*
        "
    else
        printf '
            fail %%{%s}
            nop %%sh{ rm "%s"; rm "%s" }
        ' "$(cat "$manerr")" "${colout}" "${manerr}"
    fi
} }

define-command -params ..1 \
    -shell-script-candidates %{
        find /usr/share/man/ $(printf %s "${MANPATH}" | sed 's/:/ /') -name '*.[1-8]*' | sed 's,^.*/\(.*\)\.\([1-8][a-zA-Z]*\).*$,\1(\2),'
    } \
    -docstring %{
        man [<page>]: manpage viewer wrapper
        If no argument is passed to the command, the selection will be used as page
        The page can be a word, or a word directly followed by a section number between parenthesis, e.g. kak(1)
    } man %{ evaluate-commands %sh{
    subject=${1-$kak_selection}

    ## The completion suggestions display the page number, strip them if present
    case "${subject}" in
        *\([1-8]*\))
            pagenum="${subject##*\(}"
            pagenum="${pagenum%\)}"
            subject="${subject%%\(*}"
            ;;
        *)
            pagenum=""
            ;;
    esac

    printf %s\\n "evaluate-commands -try-client %opt{docsclient} man-impl man $pagenum $subject"
} }



# The following section of code enables a user
# to go to next or previous man page links and to follow man page links,
# for example, apropos(1), that would normally appear in SEE ALSO sections.
# The user would position the cursor on any character of the link
# and then press <ret> to change to a buffer showing the man page.

# Regex pattern defining a man page link.
# Used for determining if a selection, which may just be a link, is a link.
declare-option -hidden regex man_link1 \
  [\w_.:-]+\(\d[a-z]*\)

# Same as above but with lookbehind and lookahead patterns.
# Used for searching for a man page link.
declare-option -hidden regex man_link2 \
  "(?:^|(?<=\W))%opt{man_link1}(?=\W)"

# Define a useful command sequence for searching a given regex
# and a given sequence of search keys.
define-command -hidden man-search -params 2 %{
    set-register / %arg[1]
    try %{
        execute-keys %arg[2]
    } catch %{
        fail "Could not find man page link"
    }
}

define-command -docstring 'Go to next man page link' \
man-link-next %{ man-search %opt[man_link2] n }

define-command -docstring 'Go to previous man page link' \
man-link-prev %{ man-search %opt[man_link2] <a-n> }

define-command -docstring 'Try to jump to a man page' \
man-jump %{
  try %{ execute-keys <a-a><a-w> s %opt[man_link1] <ret> } catch %{ fail 'Not a valid man page link' }
  try %{ man } catch %{ fail 'No man page link to follow' }
}

# Suggested keymaps for a user mode
declare-user-mode man

map global man 'g' -docstring 'Jump to a man page using selected man page link' :man-jump<ret>
map global man 'j' -docstring 'Go to next man page link'                        :man-link-next<ret>
map global man 'k' -docstring 'Go to previous man page link'                    :man-link-prev<ret>
map global man 'm' -docstring 'Look up a man page'                              :man<space>
declare-option -hidden range-specs spell_regions
declare-option -hidden str spell_last_lang

declare-option -docstring "default language to use when none is passed to the spell-check command" str spell_lang

define-command -params ..1 -docstring %{
    spell [<language>]: spell check the current buffer

    The first optional argument is the language against which the check will be performed (overrides `spell_lang`)
    Formats of language supported:
      - ISO language code, e.g. 'en'
      - language code above followed by a dash or underscore with an ISO country code, e.g. 'en-US'
    } spell %{
    try %{ add-highlighter window/ ranges 'spell_regions' }
    evaluate-commands %sh{
        use_lang() {
            if ! printf %s "$1" | grep -qE '^[a-z]{2,3}([_-][A-Z]{2})?$'; then
                echo "fail 'Invalid language code (examples of expected format: en, en_US, en-US)'"
                exit 1
            else
                options="-l '$1'"
                printf 'set-option buffer spell_last_lang %s\n' "$1"
            fi
        }

        if [ $# -ge 1 ]; then
            use_lang "$1"
        elif [ -n "${kak_opt_spell_lang}" ]; then
            use_lang "${kak_opt_spell_lang}"
        fi

        printf 'eval -no-hooks write %s\n' "${kak_response_fifo}" > $kak_command_fifo

        {
            sed 's/^/^/' | eval "aspell --byte-offsets -a $options" 2>&1 | awk '
                BEGIN {
                    line_num = 1
                    regions = ENVIRON["kak_timestamp"]
                    server_command = sprintf("kak -p \"%s\"", ENVIRON["kak_session"])
                }

                {
                    if (/^@\(#\)/) {
                        # drop the identification message
                    }

                    else if (/^\*/) {
                        # nothing
                    }

                    else if (/^[+-]/) {
                        # required to ignore undocumented aspell functionality
                    }

                    else if (/^$/) {
                        line_num++
                    }

                    else if (/^[#&]/) {
                        word_len = length($2)
                        word_pos = substr($0, 1, 1) == "&" ? substr($4, 1, length($4) - 1) : $3;
                        regions = regions " " line_num "." word_pos "+" word_len "|DiagnosticError"
                    }

                    else {
                        line = $0
                        gsub(/"/, "&&", line)
                        command = "fail \"" line "\""
                        exit
                    }
                }

                END {
                    if (!length(command))
                        command = "set-option \"buffer=" ENVIRON["kak_bufname"] "\" spell_regions " regions

                    print command | server_command
                    close(server_command)
                }
            '
        } <$kak_response_fifo >/dev/null 2>&1 &
    }
}

define-command spell-clear %{
    unset-option buffer spell_regions
}

define-command spell-next %{ evaluate-commands %sh{
    anchor_line="${kak_selection_desc%%.*}"
    anchor_col="${kak_selection_desc%%,*}"
    anchor_col="${anchor_col##*.}"

    start_first="${kak_opt_spell_regions%%|*}"
    start_first="${start_first#* }"

    # Make sure properly formatted selection descriptions are in `%opt{spell_regions}`
    if ! printf %s "${start_first}" | grep -qE '^[0-9]+\.[0-9]+,[0-9]+\.[0-9]+$'; then
        exit
    fi

    printf %s "${kak_opt_spell_regions#* }" | awk -v start_first="${start_first}" \
                                                  -v anchor_line="${anchor_line}" \
                                                  -v anchor_col="${anchor_col}" '
        BEGIN {
            anchor_line = int(anchor_line)
            anchor_col = int(anchor_col)
        }

        {
            for (i = 1; i <= NF; i++) {
                sel = $i
                sub(/\|.+$/, "", sel)

                start_line = sel
                sub(/\..+$/, "", start_line)
                start_line = int(start_line)

                start_col = sel
                sub(/,.+$/, "", start_col)
                sub(/^.+\./, "", start_col)
                start_col = int(start_col)

                if (start_line < anchor_line \
                    || (start_line == anchor_line && start_col <= anchor_col))
                    continue

                target_sel = sel
                break
            }
        }

        END {
            if (!target_sel)
                target_sel = start_first

            printf "select %s\n", target_sel
        }'
} }

define-command \
    -docstring "Suggest replacement words for the current selection, against the last language used by the spell-check command" \
    spell-replace %{
    prompt \
        -shell-script-candidates %{
            options=""
            if [ -n "$kak_opt_spell_last_lang" ]; then
                options="-l '$kak_opt_spell_last_lang'"
            fi
            printf %s "$kak_selection" |
                eval "aspell -a $options" |
                sed -n -e '/^&/ { s/^[^:]*: //; s/, /\n/g; p }'
        } \
        "Replace with: " \
        %{
            evaluate-commands -save-regs a %{
                set-register a %val{text}
                execute-keys c <c-r>a <esc>
            }
        }
}


define-command -params 0.. \
    -docstring "Add the current selection to the dictionary" \
    spell-add %{ evaluate-commands %sh{
    options=""
    if [ -n "$kak_opt_spell_last_lang" ]; then
        options="-l '$kak_opt_spell_last_lang'"
    fi
    if [ $# -eq 0 ]; then
        # use selections
        eval set -- "$kak_quoted_selections"
    fi
    while [ $# -gt 0 ]; do
        word="$1"
        if ! printf '*%s\n#\n' "${word}" | eval "aspell -a $options" >/dev/null; then
           printf 'fail "Unable to add word: %s"' "$(printf %s "${word}" | sed 's/"/&&/g')"
           exit 1
        fi
        shift
    done
}}
# https://www.w3schools.com/sql/default.asp
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

# Detection
# ‾‾‾‾‾‾‾‾‾

hook global BufCreate .*/?(?i)sql %{
    set-option buffer filetype sql
}

# Initialization
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾

hook global WinSetOption filetype=sql %{
    require-module sql
    set-option window static_words %opt{sql_static_words}
}

hook -group sql-highlight global WinSetOption filetype=sql %{
    add-highlighter window/sql ref sql
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/sql }
}


provide-module sql %{

# Highlighters
# ‾‾‾‾‾‾‾‾‾‾‾‾

add-highlighter shared/sql regions
add-highlighter shared/sql/code default-region group
add-highlighter shared/sql/double_string region '"' (?<!\\)(\\\\)*" fill string
add-highlighter shared/sql/single_string region "'" (?<!\\)(\\\\)*' fill string
add-highlighter shared/sql/comment1 region '--' '$' fill comment
add-highlighter shared/sql/comment2 region '#' '$' fill comment
add-highlighter shared/sql/comment3 region '/\*' '\*/' fill comment

evaluate-commands %sh{
    # Keywords
    keywords="ALTER|AS|ASC|AUTO_INCREMENT|CHECK|CONSTRAINT|CREATE|DATABASE|DEFAULT|DELETE|DESC|DISTINCT|DROP"
    keywords="${keywords}|EXISTS|FOREIGN KEY|FROM|FULL JOIN|FULL OUTER JOIN|GROUP BY|HAVING|INDEX|INNER JOIN"
    keywords="${keywords}|INSERT INTO|INTO|JOIN|LEFT JOIN|LEFT OUTER JOIN|LIMIT|MODIFY|NOT NULL|ON|ORDER BY|PRIMARY KEY"
    keywords="${keywords}|REFERENCES|RIGHT JOIN|RIGHT OUTER JOIN|SELECT|SELECT TOP|SET|TABLE|TRUNCATE|UNION|UNIQUE"
    keywords="${keywords}|UPDATE|VALUES|VIEW|WHERE"

    # Operators
    operators="ALL|AND|ANY|BETWEEN|EXISTS|IN|IS|LIKE|NOT|OR|SOME"

    # MySQL functions
    functions="ABS|ACOS|ADDDATE|ADDTIME|ASCII|ASIN|ATAN|AVG|BIN|BINARY|CASE|CAST|CEIL|CEILING"
    functions="${functions}|CHARACTER_LENGTH|CHAR_LENGTH|COALESCE|CONCAT|CONCAT_WS|CONNECTION_ID|CONV|CONVERT"
    functions="${functions}|COS|COT|COUNT|CURDATE|CURRENT_DATE|CURRENT_TIME|CURRENT_TIMESTAMP|CURRENT_USER"
    functions="${functions}|CURTIME|DATABASE|DATE|DATE_ADD|DATEDIFF|DATE_FORMAT|DATE_SUB|DAY|DAYNAME"
    functions="${functions}|DAYOFMONTH|DAYOFWEEK|DAYOFYEAR|DEGREES|DIV|EXP|EXTRACT|FIELD|FIND_IN_SET|FLOOR"
    functions="${functions}|FORMAT|FROM_DAYS|GREATEST|HOUR|IF|IFNULL|INSERT|INSTR|ISNULL|LAST_DAY"
    functions="${functions}|LAST_INSERT_ID|LCASE|LEAST|LEFT|LENGTH|LN|LOCALTIME|LOCALTIMESTAMP|LOCATE|LOG"
    functions="${functions}|LOWER|LPAD|LTRIM|MAKEDATE|MAKETIME|MAX|MICROSECOND|MID|MIN|MINUTE|MOD|MONTH"
    functions="${functions}|MONTHNAME|NOW|NULLIF|PERIOD_ADD|PERIOD_DIFF|PI|POSITION|POW|POWER|QUARTER|RADIANS"
    functions="${functions}|RAND|REPEAT|REPLACE|REVERSE|RIGHT|ROUND|RPAD|RTRIM|SECOND|SEC_TO_TIME|SESSION_USER"
    functions="${functions}|SIGN|SIN|SPACE|SQRT|STRCMP|STR_TO_DATE|SUBDATE|SUBSTR|SUBSTRING|SUBSTRING_INDEX"
    functions="${functions}|SUBTIME|SUM|SYSDATE|SYSTEM_USER|TAN|TIME|TIMEDIFF|TIME_FORMAT|TIMESTAMP"
    functions="${functions}|TIME_TO_SEC|TO_DAYS|TRIM|TRUNCATE|UCASE|UPPER|USER|VERSION|WEEK|WEEKDAY|WEEKOFYEAR"
    functions="${functions}|YEAR|YEARWEEK"

    # SQL Server functions
    functions="${functions}|CHAR|CHARINDEX|DATALENGTH|DATEADD|DATENAME|DATEPART|GETDATE|GETUTCDATE|ISDATE"
    functions="${functions}|ISNUMERIC|LEN|NCHAR|PATINDEX|SESSIONPROPERTY|STR|STUFF|USER_NAME"

    # MS Access functions
    functions="${functions}|Abs|Asc|Atn|Avg|Chr|Cos|Count|CurDir|CurrentUser|Date|DateAdd|DateDiff|DatePart"
    functions="${functions}|DateSerial|DateValue|Day|Environ|Exp|Fix|Format|Hour|InStr|InstrRev|Int|IsDate"
    functions="${functions}|IsNull|IsNumeric|LCase|Left|Len|LTrim|Max|Mid|Min|Minute|Month|MonthName|Now"
    functions="${functions}|Randomize|Replace|Right|Rnd|Round|RTrim|Second|Sgn|Space|Split|Sqr|Str|StrComp"
    functions="${functions}|StrConv|StrReverse|Sum|Time|TimeSerial|TimeValue|Trim|UCase|Val|Weekday"
    functions="${functions}|WeekdayName|Year"

    # Oracle functions
    functions="${functions}|ADD_MONTHS|ASCIISTR|BITAND|CHR|COMPOSE|COSH|DBTIMEZONE|DECOMPOSE|DUMP|INITCAP|INSTRB"
    functions="${functions}|INSTRC|LENGTHB|LENGTHC|MEDIAN|MONTHS_BETWEEN|NCHR|NEW_TIME|NEXT_DAY|REGEXP_COUNT"
    functions="${functions}|REGEXP_INSTR|REGEXP_REPLACE|REGEXP_SUBSTR|REMAINDER|ROWNUM|SESSIONTIMEZONE|SOUNDEX"
    functions="${functions}|SYSTIMESTAMP|TANH|TRANSLATE|TRUNC|TZ_OFFSET|VSIZE"

    # MySQL data types
    data_types="LONGBLOB|LONGTEXT|MEDIUMBLOB|MEDIUMTEXT|SET|TEXT|TINYTEXT"
    data_types_fn="BIGINT|BLOB|CHAR|DATE|DATETIME|DECIMAL|DOUBLE|ENUM|FLOAT|INT"
    data_types_fn="${data_types_fn}|MEDIUMINT|SMALLINT|TIME|TIMESTAMP|TINYINT|VARCHAR|YEAR"

    # SQL Server data types
    data_types="${data_types}|bigint|bit|cursor|date|datetime|datetime2|datetimeoffset|image|int|money|nchar|ntext"
    data_types="${data_types}|nvarchar|real|smalldatetime|smallint|smallmoney|sql_variant|table|text|time"
    data_types="${data_types}|timestamp|tinyint|uniqueidentifier|varbinary|xml"
    data_types_fn="${data_types_fn}|binary|char|decimal|float|numeric|nvarchar|varbinary|varchar|varchar"

    # MS Access data types
    data_types="${data_types}|Text|Memo|Byte|Integer|Long|Single|Double|Currency|AutoNumber|Date"
    data_types="${data_types}|Time|Ole Object|Hyperlink|Lookup Wizard"

    # Add the language's grammar to the static completion list
    printf %s\\n "declare-option str-list sql_static_words ${keywords} ${operators} ${functions} ${data_types} ${data_types_fn} NULL" | tr '|' ' '

    # Highlight keywords
    printf %s "
        add-highlighter shared/sql/code/ regex '(?i)\b(${functions})\(.*?\)' 0:function
        add-highlighter shared/sql/code/ regex '(?i)\b(${data_types_fn})\(.*?\)' 0:type
        add-highlighter shared/sql/code/ regex '(?i)\b(${keywords})\b' 0:keyword
        add-highlighter shared/sql/code/ regex '(?i)\b(${operators})\b' 0:operator
        add-highlighter shared/sql/code/ regex '(?i)\b(${data_types})\b' 0:type
    "
}

add-highlighter shared/sql/code/ regex '\+|-|\*|/|%|&|\||^|=|>|<|>=|<=|<>|\+=|-=|\*=|/=|%=|&=|^-=|\|\*=' 0:operator
add-highlighter shared/sql/code/ regex \bNULL\b 0:value
add-highlighter shared/sql/code/ regex \b\d+(?:\.\d+)?\b 0:value

}
# http://yaml.org
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾

# Detection
# ‾‾‾‾‾‾‾‾‾

hook global BufCreate .*[.](ya?ml) %{
    set-option buffer filetype yaml
}

# Initialization
# ‾‾‾‾‾‾‾‾‾‾‾‾‾‾

hook global WinSetOption filetype=yaml %{
    require-module yaml

    hook window ModeChange pop:insert:.* -group yaml-trim-indent yaml-trim-indent
    hook window InsertChar \n -group yaml-insert yaml-insert-on-new-line
    hook window InsertChar \n -group yaml-indent yaml-indent-on-new-line
    hook -once -always window WinSetOption filetype=.* %{ remove-hooks window yaml-.+ }
}

hook -group yaml-highlight global WinSetOption filetype=yaml %{
    add-highlighter window/yaml ref yaml
    hook -once -always window WinSetOption filetype=.* %{ remove-highlighter window/yaml }
}


provide-module yaml %{

# Highlighters
# ‾‾‾‾‾‾‾‾‾‾‾‾

add-highlighter shared/yaml regions
add-highlighter shared/yaml/code      default-region group
add-highlighter shared/yaml/double_string region '"' (?<!\\)(\\\\)*"       fill string
add-highlighter shared/yaml/single_string region "'" "'"                   fill string
add-highlighter shared/yaml/comment       region '(?:^| )#' $              fill comment

add-highlighter shared/yaml/code/ regex ^(---|\.\.\.)$ 0:meta
add-highlighter shared/yaml/code/ regex ^(\h*:\w*) 0:keyword
add-highlighter shared/yaml/code/ regex \b(true|false|null)\b 0:value
add-highlighter shared/yaml/code/ regex ^\h*-?\h*(\S+): 1:attribute

# Commands
# ‾‾‾‾‾‾‾‾

define-command -hidden yaml-trim-indent %{
    # remove trailing white spaces
    try %{ execute-keys -draft -itersel x s \h+$ <ret> d }
}

define-command -hidden yaml-insert-on-new-line %{
    evaluate-commands -draft -itersel %{
        # copy '#' comment prefix and following white spaces
        try %{ execute-keys -draft k x s ^\h*\K#\h* <ret> y gh j P }
    }
}

define-command -hidden yaml-indent-on-new-line %{
    evaluate-commands -draft -itersel %{
        # preserve previous line indent
        try %{ execute-keys -draft <semicolon> K <a-&> }
        # filter previous line
        try %{ execute-keys -draft k : yaml-trim-indent <ret> }
        # indent after :
        try %{ execute-keys -draft , k x <a-k> :$ <ret> j <a-gt> }
        # indent after -
        try %{ execute-keys -draft , k x <a-k> ^\h*- <ret> j <a-gt> }
    }
}

}
# ~/.config/kak/colors/dracula.kak
##
## base16.kak by lenormf
##

evaluate-commands %sh{
    black_lighterer='rgb:383838'
    black_lighter='rgb:2D2D2D'
    black_light='rgb:1C1C1C'
    cyan_light='rgb:7CB0FF'
    green_dark='rgb:A1B56C'
    grey_dark='rgb:585858'
    grey_light='rgb:D8D8D8'
    magenta_dark='rgb:AB4642'
    magenta_light='rgb:AB4434'
    orange_dark='rgb:DC9656'
    orange_light='rgb:F7CA88'
    purple_dark='rgb:BA8BAF'

    ## code
    echo "
        face global value ${orange_dark}+b
        face global type ${orange_light}
        face global variable ${magenta_dark}
        face global module ${green_dark}
        face global function ${cyan_light}
        face global string ${green_dark}
        face global keyword ${purple_dark}+b
        face global operator ${cyan_light}
        face global attribute ${orange_dark}
        face global comment ${grey_dark}
        face global documentation comment
        face global meta ${orange_light}
        face global builtin default+b
    "

    ## markup
    echo "
        face global title blue
        face global header ${cyan_light}
        face global mono ${green_dark}
        face global block ${orange_dark}
        face global link blue
        face global bullet ${magenta_light}
        face global list ${magenta_dark}
    "

    ## builtin
    echo "
        face global Default ${grey_light},${black_lighter}
        face global PrimarySelection white,blue+fg
        face global SecondarySelection black,blue+fg
        face global PrimaryCursor black,white+fg
        face global SecondaryCursor black,white+fg
        face global PrimaryCursorEol black,${cyan_light}+fg
        face global SecondaryCursorEol black,${cyan_light}+fg
        face global LineNumbers ${grey_light},${black_lighter}
        face global LineNumberCursor ${grey_light},rgb:282828+b
        face global MenuForeground ${grey_light},blue
        face global MenuBackground blue,${grey_light}
        face global MenuInfo ${cyan_light}
        face global Information ${black_light},${cyan_light}
        face global Error ${grey_light},${magenta_light}
        face global DiagnosticError ${magenta_light}
        face global DiagnosticWarning ${cyan_light}
        face global StatusLine ${grey_light},${black_lighterer}
        face global StatusLineMode ${orange_dark}
        face global StatusLineInfo ${cyan_light}
        face global StatusLineValue ${green_dark}
        face global StatusCursor ${black_lighterer},${cyan_light}
        face global Prompt ${black_light},${cyan_light}
        face global MatchingChar ${cyan_light},${black_light}+b
        face global BufferPadding ${cyan_light},${black_lighter}
        face global Whitespace ${grey_dark}+f
    "
}
# Kakoune default color scheme

# For Code
face global value red
face global type yellow
face global variable green
face global module green
face global function cyan
face global string magenta
face global keyword blue
face global operator yellow
face global attribute green
face global comment cyan
face global documentation comment
face global meta magenta
face global builtin default+b

# For markup
face global title blue
face global header cyan
face global mono green
face global block magenta
face global link cyan
face global bullet cyan
face global list yellow

# builtin faces
face global Default default,default
face global PrimarySelection white,blue+fg
face global SecondarySelection black,blue+fg
face global PrimaryCursor black,white+fg
face global SecondaryCursor black,white+fg
face global PrimaryCursorEol black,cyan+fg
face global SecondaryCursorEol black,cyan+fg
face global LineNumbers default,default
face global LineNumberCursor default,default+r
face global MenuForeground white,blue
face global MenuBackground blue,white
face global MenuInfo cyan
face global Information black,yellow
face global Error black,red
face global DiagnosticError red
face global DiagnosticWarning yellow
face global StatusLine cyan,default
face global StatusLineMode yellow,default
face global StatusLineInfo blue,default
face global StatusLineValue green,default
face global StatusCursor black,cyan
face global Prompt yellow,default
face global MatchingChar default,default+b
face global Whitespace default,default+fd
face global BufferPadding blue,default
# ~/.config/kak/colors/dracula.kak
source "%val{runtime}/colors/default.kak"
################
################
reg c %{
# This CLI provides the functionality to test Kakoune scripts.
# Tests live in the `test` directory and must end with `_test.kak`.

require "option_parser"

VERSION = {{ `git describe --tags --always`.chomp.stringify }}

# Temporary files
# Prepare an output file to retrieve data from Kakoune.
log_file = File.tempfile
at_exit { log_file.delete }

# Kakoune script
kakoune_script = {{ read_file("rc/test.kak") }}

OptionParser.parse do |parser|
  parser.banner = "Usage: kak-test [switches] [--] [arguments]"
  parser.on("--print-kakoune-init", "Print Kakoune script") do
    puts kakoune_script
    exit
  end
  parser.on("-h", "--help", "Show this help") do
    puts parser
    exit
  end
  parser.on("-v", "--version", "Show version") do
    puts VERSION
    exit
  end
  parser.missing_option do |flag|
    abort "ERROR: #{flag} is missing something."
  end
  parser.invalid_option do |flag|
    abort "ERROR: #{flag} is not a valid option."
  end
end

# Run tests
kak_status = Process.run("kak", { "-n", "-ui", "dummy", "-e", "#{kakoune_script}; run_tests_and_exit #{log_file.path}" })
IO.copy(log_file, STDOUT)
exit kak_status.exit_code
}
################
################
reg c %{
name: Test CI

on: [push, pull_request]

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Kakoune
        run: sudo snap install kakoune --classic

      - name: Install kakoune-test
        run: |
          curl -sSL -O https://github.com/alexherbo2/kakoune-test/releases/download/nightly/kak-test-nightly-x86_64-unknown-linux-musl.tar.xz
          tar xvf kak-test-nightly-x86_64-unknown-linux-musl.tar.xz

      - name: Run tests
        run: bin/kak-test
}
################
#source test/test_helper.kak

test test_select_words %{

  buffer_str! '*input*' %[
    [enum Color
      Red
      Green
      Blue

      def red?
        self == Color::Red
      end
    end]
  ]

  buffer_str! '*output*' %[
    [enum] [Color]
      [Red]
      [Green]
      [Blue]

      [def] [red]?
        [self] == [Color]::[Red]
      [end]
    [end]
  ]

  buffer '*input*'
  execute-keys 's\w+<ret><a-i>w'
  assert_buffer_eq '*input*' '*output*'
}

test test_select_big_words %{

  buffer_str! '*input*' %[
    [enum Color
      Red
      Green
      Blue

      def red?
        self == Color::Red
      end
    end]
  ]

  buffer_str! '*output*' %[
    [enum] [Color]
      [Red]
      [Green]
      [Blue]

      [def] [red?]
        [self] == [Color::Red]
      [end]
    [end]
  ]

  buffer '*input*'
  execute-keys 's\w+<ret><a-i><a-w>'
  assert_buffer_eq '*input*' '*output*'
}
################
# Provides basic Alacritty integration for Kakoune.
# Alacritty
# https://alacritty.org

# Commands
define-command -override alacritty-terminal-window -params .. -docstring 'alacritty-terminal-window [<program>] [<arguments>]: Creates a new terminal as an Alacritty window.' %{
  nop %sh{
    alacritty msg create-window --working-directory "$PWD" --command sh -c 'export KAKOUNE_SESSION=$1 KAKOUNE_CLIENT=$2 && shift 2 && exec "$@"' -- "$kak_session" "$kak_client" "${@:-$SHELL}"
  }
}

complete-command alacritty-terminal-window shell

define-command -override alacritty-terminal-popup -params .. -docstring 'alacritty-terminal-popup [<program>] [<arguments>]: Creates a new terminal as an Alacritty window (class: popup).' %{
  nop %sh{
    alacritty msg create-window --class=popup --working-directory "$PWD" --command sh -c 'export KAKOUNE_SESSION=$1 KAKOUNE_CLIENT=$2 && shift 2 && exec "$@"' -- "$kak_session" "$kak_client" "${@:-$SHELL}"
  }
}

complete-command alacritty-terminal-popup shell

define-command -override alacritty-terminal-panel -params .. -docstring 'alacritty-terminal-panel [<program>] [<arguments>]: Creates a new terminal as an Alacritty window (class: panel).' %{
  nop %sh{
    alacritty msg create-window --class=panel --working-directory "$PWD" --command sh -c 'export KAKOUNE_SESSION=$1 KAKOUNE_CLIENT=$2 && shift 2 && exec "$@"' -- "$kak_session" "$kak_client" "${@:-$SHELL}"
  }
}

complete-command alacritty-terminal-panel shell

define-command -override alacritty-focus -params ..1 -docstring 'alacritty-focus [<client>]: Moves focus to the given client, or the current one.' %{
  fail 'alacritty-focus: Not implemented.'
}

complete-command alacritty-focus client

# Hooks
# Alacritty detection
# Ensure that we’re running on Alacritty.
remove-hooks global alacritty-detection
hook -group alacritty-detection global ClientCreate '.*' %{
  trigger-user-hook "TERM=%val{client_env_TERM}"
}

# Alacritty integration
remove-hooks global alacritty-integration
hook -group alacritty-integration global User 'TERM=alacritty' %{
  alias global terminal alacritty-terminal-window
  alias global terminal-horizontal alacritty-terminal-window
  alias global terminal-vertical alacritty-terminal-window
  alias global terminal-tab alacritty-terminal-window
  alias global terminal-window alacritty-terminal-window
  alias global terminal-popup alacritty-terminal-popup
  alias global terminal-panel alacritty-terminal-panel
  alias global focus alacritty-focus
}
################
# tmux
# https://github.com/tmux/tmux

# Commands
define-command -override tmux-terminal-horizontal -params .. -docstring 'tmux-terminal-horizontal [<program>] [<arguments>]: Creates a new terminal to the right as a tmux pane.' %{
  tmux_impl split-window -e "KAKOUNE_SESSION=%val{session}" -e "KAKOUNE_CLIENT=%val{client}" -h %arg{@}
}

complete-command tmux-terminal-horizontal shell

define-command -override tmux-terminal-vertical -params .. -docstring 'tmux-terminal-vertical [<program>] [<arguments>]: Creates a new terminal below as a tmux pane.' %{
  tmux_impl split-window -e "KAKOUNE_SESSION=%val{session}" -e "KAKOUNE_CLIENT=%val{client}" -v %arg{@}
}

complete-command tmux-terminal-vertical shell

define-command -override tmux-terminal-window -params .. -docstring 'tmux-terminal-window [<program>] [<arguments>]: Creates a new terminal to the right as a tmux window.' %{
  tmux_impl new-window -e "KAKOUNE_SESSION=%val{session}" -e "KAKOUNE_CLIENT=%val{client}" -a %arg{@}
}

complete-command tmux-terminal-window shell

define-command -override tmux-terminal-popup -params .. -docstring 'tmux-terminal-popup [<program>] [<arguments>]: Creates a new terminal as a tmux popup.' %{
  # TODO: Remove -d flag.
  tmux_impl display-popup -e "KAKOUNE_SESSION=%val{session}" -e "KAKOUNE_CLIENT=%val{client}" -w 90% -h 90% -d %sh{pwd} -E %arg{@}
}

complete-command tmux-terminal-popup shell

define-command -override tmux-terminal-panel -params .. -docstring 'tmux-terminal-panel [<program>] [<arguments>]: Creates a new terminal as a tmux panel.' %{
  tmux_impl split-window -e "KAKOUNE_SESSION=%val{session}" -e "KAKOUNE_CLIENT=%val{client}" -h -b -l 30 -t '{left}' %arg{@}
}

complete-command tmux-terminal-panel shell

define-command -override tmux-focus -params ..1 -docstring 'tmux-focus [<client>]: Moves focus to the given client, or the current one.' %{
  evaluate-commands -try-client %arg{1} %{
    tmux_impl switch-client -t %val{client_env_TMUX_PANE}
  }
}

complete-command tmux-focus client

define-command -override -hidden tmux_impl -params .. %{
  nop %sh{
    TMUX=$kak_client_env_TMUX TMUX_PANE=$kak_client_env_TMUX_PANE nohup tmux "$@" < /dev/null > /dev/null 2>&1 &
  }
}

# Hooks
# tmux detection
# Ensure that we’re running on tmux.
remove-hooks global tmux-detection
hook -group tmux-detection global ClientCreate '.*' %{
  trigger-user-hook "TMUX=%val{client_env_TMUX}"
}

# tmux integration
remove-hooks global tmux-integration
hook -group tmux-integration global User 'TMUX=(.+?),(.+?),(.+?)' %{
  alias global terminal tmux-terminal-horizontal
  alias global terminal-horizontal tmux-terminal-horizontal
  alias global terminal-vertical tmux-terminal-vertical
  alias global terminal-tab tmux-terminal-window
  alias global terminal-window tmux-terminal-window
  alias global terminal-popup tmux-terminal-popup
  alias global terminal-panel tmux-terminal-panel
  alias global focus tmux-focus

  # Clipboard integration
  hook -group tmux-integration global RegisterModified '"' %{
    tmux_impl set-buffer -w %val{main_reg_dquote}
  }
}
#######################
define-command send-selections-to -params 1 %{
    try %{
        eval %sh{ printf '' | kak -p "$1" || printf 'fail' }
        echo -quoting kakoune -to-shell-script "kak -p '%arg{1}'" 'set-register' 'dquote' %val{selections}
        echo -markup "{Information}Sent %val{selection_count} selection(s) to session '%arg{1}'"
    } catch %{
        echo -markup "{Error}Session '%arg{1}' does not seem to exist"
    }
}
complete-command -menu send-selections-to shell-script-candidates %{ kak -l | grep -E -v "(^$kak_session|\(dead\))$" }
######

# # https://docs.microsoft.com/en-us/cpp/cpp/keywords-cpp
# syntax "**/*.{c,h,cpp,cc,hpp,hh}"
# syntax keywords alignas|alignof|and_eq|and|asm|auto|bitand|bitor|break|case|catch|class|compl|concept|const_cast|consteval|constexpr|constinit|const|continue|co_await|co_return|co_yield|decltype|default|delete|do|dynamic_cast|else|enum|explicit|export|extern|for|friend|goto|if|inline|mutable|namespace|new|noexcept|not_eq|not|operator|or_eq|or|override|private|protected|public|register|restrict|reinterpret_cast|requires|return|sizeof|static|static_assert|static_cast|struct|switch|template|thread_local|throw|try|typedef|typeid|typename|union|using|virtual|volatile|while|xor_eq|xor
# syntax types "%l{!(_t)%l%d_}|bool|char|double|float|int|long|short|signed|unsigned|void|%u{%w_}|u%d{%d}x%d{%d}|u%d{%d}|i%d{%d}x%d{%d}|i%d{%d}|f%d{%d}x%d{%d}|f%d{%d}|b%d{%d}"
# syntax symbols "%(|%)|%[|%]|%{|%}|%.|:|;|,|=|<|>|+|-|/|*|%%|%.|%!|~|?|&|%||@"
# syntax literals "true|false|this|nullptr|'{(\\')!'.}|%d{%d_}%.%w{%w_}|%d{%w_}|#{ }{%a}"
# syntax strings '"{(\\\\)(\\")!".}'
# syntax comments "//{.}|/*{!(*/).$}"

# # https://learn.microsoft.com/en-us/windows/win32/direct3dhlsl/dx-graphics-hlsl-appendix-keywords
# syntax "**/*.hlsl"
# syntax keywords asm|asm_fragment|break|case|class|column_major|compile|compile_fragment|const|continue|default|discard|do|else|export|extern|for|fxgroup|groupshared|if|in|inline|inout|interface|linear|namespace|nointerpolation|noperspective|out|packoffset|pass|precise|return|register|row_major|shared|static|struct|switch|technique|technique10|technique11|typedef|uniform|volatile|while
# syntax types "bool|cbuffer|centroid|double|dword|float%dx%d|float%d|float|half|int|lineadj|line|matrix|min16float|min10float|min16int|min12int|min16uint|pixelfragment|point|sample|sampler|snorm|stateblock|stateblock_state|string|tbuffer|texture|triangleadj|triangle|uint|unorm|unsigned|vector|vertexfragment|void|%u{%w_}"
# syntax symbols "%(|%)|%[|%]|%{|%}|%.|:|;|,|=|<|>|+|-|/|*|%%|%.|%!|~|?|&|%||@"
# syntax literals "true|false|NULL|'{(\\')!'.}|%d{%d_}%.%w{%w_}|%d{%w_}|#{ }{%a}"
# syntax strings '"{(\\\\)(\\")!".}'
# syntax comments "//{.}|/*{!(*/).$}"

# # https://www.khronos.org/opengl/wiki/Core_Language_(GLSL)
# # https://www.khronos.org/opengl/wiki/Type_Qualifier_(GLSL)
# # https://www.khronos.org/opengl/wiki/Data_Type_(GLSL)
# # https://www.khronos.org/opengl/wiki/Sampler_(GLSL)
# syntax "**/*.glsl"
# syntax keywords "attribute|buffer|centroid|coherent|const|discard|flat|for|highp|if|invariant|in|out|layout|lowp|mediump|noperspective|precise|readonly|restrict|sample|shared|smooth|struct|uniform|varying|volatile|while|writeonly|gl_{%w}"
# syntax types "bool|double|float|int|mat%dx%d|mat%d|uint|vec%d|[bdiu]vec%d|void|sampler{%w}|[iu]sampler{%w}|image{%w}[iu]image{%w}"
# syntax symbols "%(|%)|%[|%]|%{|%}|%.|:|;|,|=|<|>|+|-|/|*|%%|%.|%!|~|?|&|%||@"
# syntax literals "true|false|NULL|'{(\\')!'.}|%d{%d_}%.%w{%w_}|%d{%w_}|#{ }{%a}"
# syntax strings '"{(\\\\)(\\")!".}'
# syntax comments "//{.}|/*{!(*/).$}"

# # https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/
# syntax "**/*.cs"
# syntax keywords abstract|as|base|break|case|catch|checked|class|const|continue|default|delegate|do|else|enum|event|explicit|extern|finally|fixed|foreach|for|goto|if|implicit|in|interface|internal|is|lock|namespace|new|operator|out|override|params|private|protected|public|readonly|ref|return|sealed|sizeof|stackalloc|static|struct|switch|throw|try|typeof|unchecked|unsafe|using|virtual|volatile|while|add|alias|ascending|async|await|by|descending|dynamic|equals|from|get|global|group|into|join|let|nameof|not|on|orderby|partial|remove|select|set|unmanaged|value|var|when|where|yield
# syntax types "bool|byte|char|decimal|double|float|int|long|object|sbyte|short|string|uint|ulong|ushort|void|%u{%w_}"
# syntax symbols "%(|%)|%[|%]|%{|%}|%.|:|;|,|=|<|>|+|-|/|*|%%|%.|%!|?|&|%||@"
# syntax literals "true|false|this|null|'{(\\')!'.}|%d{%d_}%.%w{%w_}|%d{%w_}|#{%a}"
# syntax strings '"{(\\\\)(\\")!".}'
# syntax comments "//{.}|/*{!(*/).$}"

# # https://docs.python.org/3/reference/lexical_analysis.html#keywords
# syntax "**/*.py"
# syntax keywords and|as|assert|async|await|break|class|continue|def|del|elif|else|except|finally|for|from|global|if|import|in|is|lambda|nonlocal|not|or|pass|raise|return|try|while|with|yield
# syntax types "%u{%w_}"
# syntax symbols "+|-|*|/|%%|<|>|=|~|%(|%)|%{|%}|%[|%]|;|%.|:|,|%."
# syntax literals "None|False|True|%d{%d_}%.%w{%w_}|%d{%w_}"
# syntax strings {'{(\\)(\')!'.}|"{(\\)(\")!".}}
# syntax comments "#{.}"

# syntax "**/*.{bat,cmd}"
# syntax keywords "call|defined|do|echo%.|echo|else|exit|for|goto|if|not|setlocal|set"
# syntax types "%%%u{!%%%u%d_}|%%%u{!:%u%d_}{!%%.}"
# syntax symbols "%(|%)|<|>|=|~|*|&|%%|%!|%||@"
# syntax literals "-%w{%w_-}|/%w{%w_-}|%d{%w}"
# syntax strings {'{(\\)(\')!'.}|"{(\\)(\")!".}}
# syntax comments "rem{.}"
# syntax texts "{%w_-%.}"
