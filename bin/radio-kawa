#!/bin/sh

TMP=$(mktemp --directory)
trap "rm --recursive $TMP" EXIT

FILTER=${FILTER:-cat}
GREPER=${GREPER:-grep}

pattern=${1:-.}
format=${2:-'#{item.enclosure.url} #{item.title}'}
separator=${3:-'
'}

curl --silent --location radiokawa.com/les-archives/ |
pcregrep --only-matching=1 'radiokawa.com/([a-z-]+/[a-z-]+)/' |
egrep --invert-match '^(comments|voix|wp)' |
sort |
uniq |
$GREPER "$pattern" |
$FILTER > $TMP/emissions

test $? = 0 || {
  exit 1
}

while read emission; do
  echo $emission > $TMP/emission
  IFS=/ read category name < $TMP/emission
  rss-get -reverse -- http://feeds.radiokawa.com/podcast_$name.xml "$format" "$separator"
done < $TMP/emissions
