# Kakoune
# https://kakoune.org
#
# Configuration:
#
# https://github.com/Delapouite/dot-in-the-sky/blob/master/.config/kak/kakrc
# https://github.com/mawww/config/blob/master/kakrc
# https://github.com/occivink/config/blob/master/.config/kak/kakrc
# https://github.com/topisani/dotfiles/blob/master/config/kak/kakrc
# https://gitlab.com/vbauerster/dotfiles/-/blob/master/.config/kak/kakrc

# Preamble ─────────────────────────────────────────────────────────────────────

try %sh{
  kcr init kakoune
  kak-lsp --kakoune --session "$kak_session"
}

source ~/projects/alacritty.kak/rc/alacritty.kak
source ~/projects/auto-pairs.kak/rc/auto-pairs.kak
source ~/projects/crystal.kak/rc/crystal.kak
source ~/projects/git.kak/rc/git.kak
source ~/projects/indent.kak/rc/indent.kak
source ~/projects/mark.kak/rc/mark.kak
source ~/projects/pipe.kak/rc/pipe.kak
source ~/projects/select.kak/rc/select.kak
source ~/projects/sensible.kak/rc/sensible.kak
source ~/projects/shortcuts.kak/rc/shortcuts.kak
source ~/projects/show-whitespaces.kak/rc/show-whitespaces.kak
nop source ~/projects/snippet.kak/rc/snippet.kak
source ~/projects/surround.kak/rc/surround.kak
source ~/projects/text-objects.kak/rc/text-objects.kak
source ~/projects/tiny.kak/rc/tiny.kak
source ~/projects/tmux.kak/rc/tmux.kak
source ~/projects/window.kak/rc/window.kak

# Kakoune support
# https://github.com/mawww/kakoune/tree/master/rc
try %{
  source-runtime rc/detection/file.kak
  source-runtime rc/filetype/asciidoc.kak
  source-runtime rc/filetype/c-family.kak
  source-runtime rc/filetype/css.kak
  source-runtime rc/filetype/eruby.kak
  source-runtime rc/filetype/etc.kak
  source-runtime rc/filetype/html.kak
  source-runtime rc/filetype/i3.kak
  source-runtime rc/filetype/ini.kak
  source-runtime rc/filetype/javascript.kak
  source-runtime rc/filetype/json.kak
  source-runtime rc/filetype/kakrc.kak
  source-runtime rc/filetype/lisp.kak
  source-runtime rc/filetype/lua.kak
  source-runtime rc/filetype/makefile.kak
  source-runtime rc/filetype/markdown.kak
  source-runtime rc/filetype/nix.kak
  source-runtime rc/filetype/ruby.kak
  source-runtime rc/filetype/rust.kak
  source-runtime rc/filetype/scss.kak
  source-runtime rc/filetype/sh.kak
  source-runtime rc/filetype/toml.kak
  source-runtime rc/filetype/yaml.kak
  source-runtime rc/tools/comment.kak
  source-runtime rc/tools/doc.kak
  source-runtime rc/tools/grep.kak
  source-runtime rc/tools/make.kak
  source-runtime rc/tools/man.kak
}

# Detection ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈

remove-hooks global sh-config
hook -group sh-config global BufOpenFile '.*/(profile|bashrc|tmux.conf)' %{
  set-option buffer filetype sh
}

# Options ──────────────────────────────────────────────────────────────────────

# UI options
set-option global startup_info_version 20211231
set-option global ui_options terminal_assistant=none
remove-scratch-message

# Color scheme
# Dracula – https://draculatheme.com/kakoune
source ~/projects/dracula/kakoune/colors/dracula.kak

# Status line
declare-cursor-character-unicode
set-option global modelinefmt '%val{bufname} %val{cursor_line}:%val{cursor_char_column} {{context_info}} {{mode_info}} - U+%opt{cursor_character_unicode} - %val{client}@%val{session}'

# LSP
try lsp-enable
remove-highlighter global/lsp_error_lines

# Indentation
set-indent global 2
enable-detect-indent
enable-auto-indent

# Auto-pairing of characters
enable-auto-pairs

# Integration
synchronize-terminal-clipboard
make-directory-on-save

# Show whitespaces
show-whitespaces

# Show various characters
# https://unicode-table.com
add-highlighter -override global/U+2013 regex '–' '0:green+f'
add-highlighter -override global/U+2014 regex '—' '0:green+bf'
add-highlighter -override global/math-symbols regex '[−×]' '0:cyan+f'

# Mappings ─────────────────────────────────────────────────────────────────────

# Normal mode ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈

# Hot reloading
map -docstring 'reload kakrc' global user R ': source-kakrc; echo reloaded kakrc<ret>'

# Enter command mode
map -docstring 'enter command' global normal <ret> :

# Editing
map -docstring 'save' global normal <c-s> ': write; echo saved<ret>'
map -docstring 'quit' global normal <c-q> ': quit<ret>'
map -docstring 'last buffer' global normal <c-a> ga

# Selection primitives
map -docstring 'surround mode' global normal q ': surround-mode<ret>'
map -docstring 'select mode' global normal S ': select-mode<ret>'

# Windowing
map -docstring 'terminal (popup)' global normal <c-ret> ': connect terminal-popup<ret>'
map -docstring 'git (popup)' global normal <c-l> ': connect terminal-popup gitui<ret>'
map -docstring 'file explorer' global normal <c-e> ': connect terminal-panel sidetree --select %val{buffile}<ret>'
map -docstring 'file picker' global normal <c-f> ': connect terminal-popup kcr fzf files<ret>'
map -docstring 'buffer picker' global normal <c-b> ': connect terminal-popup kcr fzf buffers<ret>'
map -docstring 'grep picker' global normal <c-g> ': connect terminal-popup kcr fzf grep<ret>'
map -docstring 'grep picker (buffer)' global normal <c-r> ': connect terminal-popup kcr fzf grep %val{buflist}<ret>'

# Notes ────────────────────────────────────────────────────────────────────────

map -docstring 'open notes' global user w ': edit ~/docs/notes.txt<ret>gjvt'

add-highlighter -override shared/notes group
add-highlighter -override shared/notes/entry-date-year regex '(?S)^(\d{4}) (.+)$' 1:comment 2:default
add-highlighter -override shared/notes/entry-date-year-month regex '(?S)^(\d{4}-\d{2}) (.+)$' 1:comment 2:default
add-highlighter -override shared/notes/entry-date regex '(?S)^(\d{4}-\d{2}-\d{2}) (\w{3}) (.+)$' 1:comment 2:comment 3:default
add-highlighter -override shared/notes/entry-date-time regex '(?S)^(\d{4}-\d{2}-\d{2}) (\w{3}) (\d{2}:\d{2}) (.+)$' 1:comment 2:comment 3:comment 4:default
add-highlighter -override shared/notes/info regex '(\()([^)]+)(\))' 1:default+d 2:blue 3:default+d
add-highlighter -override shared/notes/tag regex '(\[)([^\]]+)(\])' 1:default+d 2:cyan 3:default+d
add-highlighter -override shared/notes/keywords group
add-highlighter -override shared/notes/keywords/ regex 'Buy' 0:yellow
add-highlighter -override shared/notes/keywords/ regex 'Go to' 0:cyan
add-highlighter -override shared/notes/keywords/ regex 'Sign up' 0:blue
add-highlighter -override shared/notes/keywords/ regex 'Update' 0:yellow
add-highlighter -override shared/notes/keywords/ regex 'Watch' 0:cyan

remove-hooks global notes
hook -group notes global BufCreate '.*/docs/notes.txt' %{
  add-highlighter -override buffer/notes ref notes
  map -docstring 'insert date (2006-01-02 Mon)' buffer insert <c-u> '<a-;>!date ''+%F %a'' | tr -d ''\n''<ret>'
  map -docstring 'insert date (2006-01-02 Mon 15:04)' buffer insert <c-i> '<a-;>!date ''+%F %a %H:%M'' | tr -d ''\n''<ret>'
  map -docstring 'save and close buffer' buffer normal <c-w> ': write; delete-buffer<ret>'
}
