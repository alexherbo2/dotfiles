# Make tmux modal
# – Unset prefix
# – Enter prefix mode (yellow) with Control + Space
# – Exit mode (green) with Escape
#
# – https://alexherbo2.github.io/config/tmux/add-prefix-mode/
# – https://alexherbo2.github.io/config/tmux/make-tmux-modal/
set-option -g prefix None
bind-key -n C-Space {
  set-option key-table prefix
  set-option status-bg yellow
}
bind-key Escape {
  set-option key-table root
  set-option status-bg green
}

# Quirks
# Restore root table on detach
set-hook -g client-detached[0] 'set-option key-table root'
set-hook -g client-detached[1] 'set-option status-bg green'

# Restore root table in tree mode
bind-key s {
  choose-tree -Z -s
  set-option key-table root
  set-option status-bg green
}

# Status line
# Only display active modes in the status line
set-option -g status-left '[#{session_name}] #{?#{!=:#{client_key_table},root},[#{client_key_table}] ,}'
set-option -g status-left-length 0
# Right: (othala) 15:04
set-option -g status-right '(#{host_short}) %H:%M'
set-option -g status-right-length 0

# Fixes delay in modal applications
set-option -s -g escape-time 0

# Pass focus events through to applications
set-option -g focus-events on

# Enable mouse support
set-option -g mouse on

# Start numbering at 1
set-option -g base-index 1 # Window
set-option -w -g pane-base-index 1

# Automatically renumber windows
set-option -g renumber-windows

# Palette switching
# FAQ: I’m using tmux and colors look weird
# $ tic /path/to/kakoune/contrib/tmux-256color.terminfo
# https://github.com/mawww/kakoune/blob/master/doc/pages/faq.asciidoc#im-using-tmux-and-colors-look-weird
set-option -g default-terminal tmux-256color
set-option -g -a terminal-overrides ',*col*:Tc'

# Login shell
# Note: default-shell requires full path
set-option -g default-command elvish

# Prompt
bind-key Enter command-prompt

# Reload
bind-key r {
  source-file ~/.tmux.conf
  display-message 'Reloaded configuration'
}

# Layouts
bind-key m select-layout main-horizontal
bind-key M select-layout main-vertical
bind-key e select-layout even-vertical
bind-key E select-layout even-horizontal

# Window
bind-key c new-window
bind-key C new-window -c '#{pane_current_path}'

# Same without prefix
bind-key -n C-Left new-window
bind-key -n C-Up new-window -c '#{pane_current_path}'

# Split
bind-key o split-window -v -c '#{pane_current_path}'
bind-key O split-window -h -c '#{pane_current_path}'

# Same without prefix
bind-key -n C-Down split-window -v -c '#{pane_current_path}'
bind-key -n C-Right split-window -h -c '#{pane_current_path}'

# Kill focused pane (without confirmation)
bind-key x kill-pane

# Same without prefix
bind-key -n F4 kill-pane

# Focus
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Focus panes without prefix
bind-key -n C-h select-pane -L
bind-key -n C-j select-pane -D
bind-key -n C-k select-pane -U
bind-key -n C-l select-pane -R

# Switch to window
# https://github.com/alexherbo2/tmux-tools
bind-key 1 run-shell 'tmux-select-window 1'
bind-key 2 run-shell 'tmux-select-window 2'
bind-key 3 run-shell 'tmux-select-window 3'
bind-key 4 run-shell 'tmux-select-window 4'
bind-key 5 run-shell 'tmux-select-window 5'
bind-key 6 run-shell 'tmux-select-window 6'
bind-key 7 run-shell 'tmux-select-window 7'
bind-key 8 run-shell 'tmux-select-window 8'
bind-key 9 run-shell 'tmux-select-window 9'
bind-key 0 run-shell 'tmux-select-window 10'

# Same without prefix
bind-key -n M-1 run-shell 'tmux-select-window 1'
bind-key -n M-2 run-shell 'tmux-select-window 2'
bind-key -n M-3 run-shell 'tmux-select-window 3'
bind-key -n M-4 run-shell 'tmux-select-window 4'
bind-key -n M-5 run-shell 'tmux-select-window 5'
bind-key -n M-6 run-shell 'tmux-select-window 6'
bind-key -n M-7 run-shell 'tmux-select-window 7'
bind-key -n M-8 run-shell 'tmux-select-window 8'
bind-key -n M-9 run-shell 'tmux-select-window 9'
bind-key -n M-0 run-shell 'tmux-select-window 10'

# Move focused pane to window
# Shift + <number> on the US layout
# https://github.com/alexherbo2/tmux-tools
bind-key '!' run-shell 'tmux-move-pane-to-window 1'
bind-key '@' run-shell 'tmux-move-pane-to-window 2'
bind-key '#' run-shell 'tmux-move-pane-to-window 3'
bind-key '$' run-shell 'tmux-move-pane-to-window 4'
bind-key '%' run-shell 'tmux-move-pane-to-window 5'
bind-key '^' run-shell 'tmux-move-pane-to-window 6'
bind-key '&' run-shell 'tmux-move-pane-to-window 7'
bind-key '*' run-shell 'tmux-move-pane-to-window 8'
bind-key '(' run-shell 'tmux-move-pane-to-window 9'
bind-key ')' run-shell 'tmux-move-pane-to-window 10'

# Refresh the current pane
bind-key -n F5 send-keys C-l

# Move panes
bind-key H swap-pane -s '{left-of}'
bind-key J swap-pane -s '{down-of}'
bind-key K swap-pane -s '{up-of}'
bind-key L swap-pane -s '{right-of}'

# Move panes to the next or previous window
bind-key M-H move-pane -t :-1
bind-key M-L move-pane -t :+1

# Resize panes
bind-key C-h resize-pane -L 1
bind-key C-j resize-pane -D 1
bind-key C-k resize-pane -U 1
bind-key C-l resize-pane -R 1

# Move windows
bind-key N {
  swap-window -t +1
  next-window
}
bind-key P {
  swap-window -t -1
  previous-window
}

# Full-screen
bind-key f resize-pane -Z

# Same without prefix
bind-key -n F11 resize-pane -Z

# Aliases
set-option command-alias[0] rns=rename-session
set-option command-alias[1] rn=rename-window
set-option command-alias[2] mv='move-window -t'

# Copy mode ────────────────────────────────────────────────────────────────────

# vi key-bindings
set-option -g mode-keys vi

# Copy mode
bind-key v copy-mode
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Copy and paste
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel wl-copy
bind-key C-v paste-buffer

# Start selection
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi M-Escape send-keys -X clear-selection

# Move [b] to [q], so that [qwe] actions are aligned.
bind-key -T copy-mode-vi q send-keys -X previous-word

# Long jumps
bind-key -T copy-mode-vi H send-keys -X start-of-line
bind-key -T copy-mode-vi L send-keys -X end-of-line
bind-key -T copy-mode-vi J send-keys -X page-down
bind-key -T copy-mode-vi K send-keys -X page-up
